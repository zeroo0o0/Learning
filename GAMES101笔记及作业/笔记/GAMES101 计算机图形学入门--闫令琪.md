

# GAMES101 计算机图形学入门--闫令琪

## 前言

* 据28定律，真正对结果有用的可能只占20% （
* 抓大放小
* p（） 为该lecture的PPT第（）页







## Lecture 01  计算机图形学概述

### 什么是图形学

需要操纵视觉信息，如可视化

渲染的一个关键技术：

全局光照

* 做的好：整个画面比较亮，看起来比较舒服；

* 比较暗：技术不足

>应用
>
>* 电影
>
>    * 《黑客帝国》99年→特效是最简单的CG应用
>
>    * 《阿凡达》→ 动捕做的很好
>
>    * 《疯狂动物城》→动物毛发，复杂几何形体，渲染render（计算光线的传播方式）
>
>    * 《冰雪奇缘2》√→模拟/动画，微小粒子运动，衣服形状变化，头发碰撞
>
>* CAD （电脑辅助设计）
>
>    * 曲面：几何
>
>    * 光照
>    * 模拟碰撞
>
>* 可视化：一种操纵视觉信息的方法
>    * CT检查→检测出一些信息并用一些方法以视觉信息显示出来
>* 虚拟现实（Virtual Reality)& 增强现实 AR
>    * VR看到的都是虚拟的，
>* 数字图像
>    * IPAD绘画，PS
>* 模拟/仿真/动画
>    * 特效
>    * 物体，光线
>* GUI  图形用户接口  graphical user interfaces
>* typography 字体  ： 点阵，适量
>    * the quick brown fox jumps over the lazy dog 包含26个英文字母，测试字母完整性

理解物理世界（输入）+创造新的东西（输出）

> 裸眼3D， 全息影响

### 为什么要学

CG is awesome!



Q&A

### 这门课说什么

* 光栅化rasterization： OpenGL，shender

  概念：三维空间几何形体展示在屏幕上       

  >  实时（生成 30帧/s，否则是离线）CG的主要应用

* 曲线和曲面： 几何

  如何表示曲线/曲面

* 光线追踪

  trade off：为了某些目标牺牲其他目标

  慢但是生产的画面真实

  优化：实时光线追踪

* 动画 / 模拟 / 仿真

不说什么

* OpenGL / DirectX / Vulcan（图形学 API）
* 3D建模/游戏开发    Maya  / 3DS
* CV：一切需要猜测的内容， 识别，分析理解东西
* DL

model <--> imge

> CG
>
> * 渲染： 综合考虑三维物体模型，转化成一幅图
> * 物与物、光线相互作用， 与图像无关
>
> CG
>
> 从一幅图理解出不同物体模型
>
> image→image： 图生图
>
> 计算摄影学：误用   用不同摄像方法，拍不同的图，拍子弹飞行的图

结合越来越紧密，边界越来越模糊





## Lecture 02 向量与线性代数

CG依赖

* 基础数学（**线代**，概率论，微积分），
* 光学，力学知识
* 信号处理
* 数值分析
* 一点美感



**线代：**

* 向量：点乘，叉乘
* 矩阵：乘

### 向量vector

物理喜欢叫矢量

长度 and 方向       	单位向量：a hat(^)

一般用列向量

* 几何理解：平行四边形法则、三角形法则

* 代数形式：直角坐标系，坐标



### 两种不同运算

* #### 点乘：abcosθ      dot product    结果是标量
  
  *  作用：
    *  计算夹角：
       *  看看方向上多接近
       *  判断前后
    *  计算投影向量
    * 分解向量 
  
* #### 叉乘：absinθ      cross product    结果是向量
  
  * 没有交换律，**符号相反**
  * 有分配律和结合律
  * **作用**      ***
    * 判断左和右
    * 判断内和外     p点一直在三角形三条边左边或右边
    * 得0的话  corner case 自己随便决定

这门课都是右手坐标系，x叉乘y=+z →  向量可以用来定义坐标系：x，y，z    表示很方便



### 矩阵

A m*n    m行n列

* 乘积

* 交换律不行   AB≠BA

* 有结合律，分配律

* 和向量乘： 认为向量是列向量，矩阵在左，向量在右

* 变换：x→-x

* （-1，0

     0，-1）关于y对称

* 转置

注：点乘，叉乘可以写成矩阵形式





## Lecture 03 变换（二维与三维）

变换 transformation

这节课

* 为什么学变换，是什么
* 2D变换：旋转 / 缩放 / 切变 
* 齐次坐标
* 构造新变换



### 为什么学变换

从应用来看很重要

* 模型变换
* 视图变换

> 静态场景，移动摄像机
>
> 移动机器人
>
> 拍照 3D→2D ：投影变换



### 2维变换

* 把矩阵和变换联系起来

#### 缩放变换

y'=sy

x'=sx

写成矩阵形式

#### 对称

x'=-x

y'=y

→ 写成矩阵（-1，0

​						  0， 1）

#### 切变  shear

图有弹性，下边固定，拉伸上边： y不变，只x变化

y'=y

x'=x+ay

→ [1   a           

​	  0	1]

#### 2维旋转 rotate

* 平面内
* 规定
  * 默认绕着原点转
  * 默认逆时针

x'=ax+by

y'=cx+dy

* **线性变换**： 矩阵* 输入向量  =输出向量

* 要相同维度的矩阵来乘这个向量



### 齐次坐标

#### 为什么有这个概念

平移  translation：

x'=x+tx

y'=y+ty

无法写成线性变换的形式

* trade off ： 为了某些目标牺牲其他目标， 如 算法里空间换时间
* 仿射变换 affine transformation： 都可以写成齐次坐标的形式
  * 平移
  * 线性变换

**引入齐次坐标最大目的**：增加一个数把平移变换写成  矩阵*向量形式    

*  2D点：(x，y，1)
* 2D向量:（x，y，0）

> 向量有平移不变性，所以加0
>
> point + point 点： 表示两个点的中点
>
> * (x,y,2) →（x/2， y/2， 1）      （x,y,w) 表示  （x/w， y/w） 这个二维点

#### 代价：

引入了额外的数字   变成9个数    

* 2维仿射变换 最后一行（0，0，1），其他变换不一定 ，有其自己的意义



### 逆变换

反过来操作，回到原来的状态    * M逆

* 旋转-θ角== 旋转矩阵R（θ）的逆 == 旋转矩阵R（θ）的转置
* 数学上“ 矩阵的逆 == 矩阵的转置 ”叫**正交矩阵**



### 变换的组合

* 复杂变换可以由多个简单变换组成
* 变换的顺序很重要
* 矩阵乘法不能用交换律
* 这门课默认列向量，so矩阵放在左边
* 越先的操作越靠近列向量（从右到左）
* 推广
  * 给某个点连续应用A1\*A2...*An
  * 矩阵有结合律
  * 变换分解：
    * 绕任意C点旋转：T（-c）把c移到原点→旋转→移回原处



### 3维变换

类比2维变换

* 3D点：(x，y，z，1)
* 3D向量:（x，y，z，0）

> 规定：（x，y，z，w）若w!=0   表示点
>
> (x,y,z, 2) →（x/2， y/2，z/2， 1）     表示  （x/w， y/w，z/w） 这个3维点

* 4x4： 先线性变换再平移





## Lecture 04 变换（模型、视图、投影）

补充：旋转-θ角== 旋转矩阵R（θ）的逆 == 旋转矩阵R（θ）的转置

### 3维变换

观测变换

* 视图变换

* 投影变换

  * 正交投影
  * 透视投影

  

仿射变换（平移+线性变换）   4x4 矩阵还是具有一定规律

* 最后一行（0，0，0，1)
* 最后一列前三个  tx，ty，tz：平移
* 左上3x3：表示线性变换

类比2维，先线性变换，再加偏移量



+ 缩放

* 平移

* **旋转**：三维空间中最复杂的操作

  

#### 旋转

##### 绕固定轴旋转

* 循环对称的性质：Ry是反的，因为y=z叉乘x  
  *  [「GAMES101」关于右手坐标系下绕y轴旋转的矩阵Ry“不太一样”的思考_绕y轴旋转矩阵为什么不一样-CSDN博客](https://blog.csdn.net/weixin_45073562/article/details/120444346)
  * **右手坐标系**具有循环对称性质：x × y → z 、 y × z → x 、 z × x → y 。而从 y  轴逆向看去，x 是纵轴，z  是横轴，即 z-x 坐标系，与上面正好相反。在 x -z 下逆时针旋转在 z-x 下会变为顺时针。故矩阵有所变化，四个三角函数值形成的矩阵为原来的逆。而**逆矩阵=转置矩阵**（由二维推广来）

<img src="https://i-blog.csdnimg.cn/blog_migrate/3afc479e467dd61c288ecb05a52744a7.png#pic_center" alt="img" style="zoom: 25%;" />

![image-20240916235805050](.\CG入门img\image-20240916235805050.png)

##### 一般性/任意旋转

复杂问题转化为简单问题的组合

Rxyz(α，β，γ）=Rx*Ry\*Rz      欧拉角



以上都是绕正交坐标轴旋转，有时候需要绕给定的任意轴旋转

* 罗德里格斯公式：<img src="https://pic1.zhimg.com/80/v2-d9a2729bbee7281c6b41a464be5b7df8_720w.webp" alt="img" style="zoom:50%;" />

* 用途：把任意旋转写成矩阵

* 推导繁琐，但思想比较简单：

  > 分解成平行n方向和垂直n方向，旋转垂直n方向的分量后相加即可
  >
> 推导 + 叉积和点积写成矩阵相乘     ppt  p10

* 与起点、方向有关系

* 默认：起点在原点，方向为n，旋转角度为α

* 任意轴：先把起点移到原点→旋转→移回去

* 叉乘：可以把一个向量写成矩阵再与另一个向量叉乘

* **四元数**：四元数（Quaternion）的引入更多是为了旋转与旋转之间的插值

  骨骼动画里在关键帧之间插中间帧，用四元数

矩阵（15度+25度 ）/2 ≠  旋转20度的矩阵



### 观测变换

为什么学？

学变换的目的：把3维空间的物体变成一张照片(2维)

拍照的过程   mvp变换

* 模特找好地方，摆好姿势（模型model变换）
* 找个好的角度，一个好的摄像机位置（视图view变换）  （**主要说**）
* 拍照（投影projection变换）

#### 视图变换

* 位置   e
* 往哪看   g
* 相机本身旋转角度  t     \ | /
* 相机和物体相对位置：
  * 约定相机标准位置：永远在原点，且相机沿着-z看→ 简化操作
  * 物体随相机移动
  * 怎么操作
    * e移到原点
    * g旋转到-z去
    * t旋转到Y方向
    * **旋转矩阵是正交矩阵：逆=转置**
    * 物体随相机移动（用同样变换） ：so有人称为模型视图变换

#### 投影变换

* 正交投影：多用于工程制图
* 透视投影：平行线不再平行，相交于一点，近大远小

> 本质区别：有无近大远小

##### 正交投影：orthographic projection

简单理解方式：

* 调整相机位置

* 丢掉z值  （大小不变）
* x，y移到[-1~1]的小矩形上（约定俗成，方便后续计算）→得到结果

正式方式：

* 给定一个立方体：给定x:[l,r]，.y:[b,t]，z: [far,near] (near>far)范围，六个数  (y向上，z向外，x向右，右手系)  向-z去看

* 映射到标准/规范/正则canonical  立方体[-1~1]^3

  * 平移：中心移到原点
  * 缩放：缩放x，y，z

  > opengl:左手系，缺点：x叉乘y ≠ z， z朝里   优点：far>near   [n,f]

写成矩阵形式：2个矩阵相乘

* 平移因子  -(r+l)/2  ...   （靠右）
* 缩放因子  2/(r-l) ...



##### 透视投影   perspective projection

<img src="https://pic2.zhimg.com/80/v2-63e94467c4bb70e2ee008c8a0fb428b9_720w.webp" alt="img" style="zoom:50%;" />

<img src="https://picx.zhimg.com/80/v2-e8ac88642c68df2d9eb790a800bd2e9f_720w.webp" alt="img" style="zoom:50%;" />

<img src="https://picx.zhimg.com/80/v2-1a59e6ee580ca3954e8cce586e1db179_720w.webp" alt="img" style="zoom:50%;" />

* >靠近右边的矩阵先起作用
  >
  >显然l+r=0，b+t=0（r正数，l是负数）
  >
* CG应用里用的最广泛的

* 性质：近大远小    远的大平面看起来变小

* 视觉效果：平行线（欧式几何，同一平面内）不再平行

  > 一个平面被投影到另一个平面，这种情况下不再是平行线了

* (x,y,x,1),  (kx,ky,kz,k!=0) 都表示(x,y,z) in 3D

怎么做

* 视锥frustum往里挤成长方体
  * 规定：近平面上点不变，远平面的z不变（仍在远平面上），远平面向里收缩
  * 中心点仍然是中心
* 再正交投影 

nx/z   不确定是哪个点→z不确定

特殊点

* 近平面上的点 （x,y,n) 不变
* 远平面中心点   (0,0,f) 不变

最后推出矩阵  Matrix(透视→正交)





## [作业0](https://blog.csdn.net/2301_79799657/article/details/142314076)





## Lecture 05 光栅化1（三角形的离散化）

观测变换下一步：

### 画在屏幕上（光栅化）

 透视投影：

* 近远平面深度z不变
* 远平面压成和近平面一样大

#### 如何定义视锥：p5

* 定义垂直可视角度     

  >  越小透视投影越不明显，越接近正交投影       近距离：广角，可视角度大； 

* 定义宽高比（宽/高） 

> 通过垂直可视角度，宽高比（长宽比）可以推出水平可视角度

透视投影：先转换到正交投影，再正交投影

结果：都变成[-1,1]^3 标准立方体

下一步：画在屏幕上

#### 屏幕

定义屏幕：图形学认为是二维数组，数组中每一元素是像素

分辨率：屏幕大小（像素多少）  

>  1920*720   720p
>
> 1920*1080  1080p

屏幕：光栅成像设备

Raster: 屏幕in德语

Rasterize光栅化：把多边形画在屏幕上

像素picture element→px：颜色一定的小方块，不变化的最小单位

> * 一个像素表示不同颜色（灰度），一般划分为256个等级（0：黑， 255：白）  
>
> * RGB 颜色通常通过三个数字来表示，每个数字代表一种颜色的强度，取值范围通常是从0到255。例如，纯红色可以表示为 (255, 0, 0)，纯绿色为 (0, 255, 0)，纯蓝色为 (0, 0, 255)，而白色则是所有颜色光的最强组合，表示为 (255, 255, 255)。

#### 屏幕空间

屏幕上建立坐标系  p9

规定（约定俗成）：

* 像素坐标index：
  * 左下角为原点（0，0）（x，y） 用整数坐标表示
  * （0，0）to（宽-1，高-1）   分辨率width*height 
  * 像素中心在（x+0.5，y+0.5） 
* 一个像素覆盖1，屏幕大小（0，0）→（width，height）

### **视口变换** p11：

[-1,1]^3 内的东西（多边形）映射到屏幕上  

* 先不管z
* [-1,1]^2 拉到（0，width）*（0，height）
  * 缩放x，y
  * 移动到（width/2，height/2）→ 移到中点
  * z方向不动

光栅化：多边形打碎成像素

> 绘制工具
>
> 光栅显示设备（成像设备）
>
> * 示波器：
>
>   * 显示曲线  
>   * 和早期显示器，如早期电视成像原理一样
>   * 阴极射线管CRT屏幕，电子加速后穿过显示设备发生偏转，打在显示器上， 伤眼睛
>   * CRT显示器扫描方式：隔行扫描
>     * 画图工作量少一半，两幅画间隔时间短，人眼有视野占牛
>     * 问题：会造成高速移动的画面撕裂，图像会有鬼影
>
> * 现代：
>
>   * 显卡内存：显存memory
>   * 显示图像：内存一块区域的内容映射到屏幕上
>
> * 现在主要显示设备：平板显示设备：LCD
>
>   * 计算器
>   * 手机
>   * 视网膜屏幕：分辨率>视网膜
>
>   > LCD 液晶显示器  liquid crystal display
>   >
>   > * 通过液晶扭曲，把光震动方向给调出来（类似于偏振片）
>   >
>   > LED 发光二极管  light emitting diode
>   >
>   > 电子墨水屏：
>   >
>   > * 黑白墨水，通过不同电压/模式，控制黑白翻转
>   >* 问题刷新率很低，改变黑白朝向需要肉眼可见的时间

下一步：把多边形拆成不同的像素

#### 怎么在成像设备上画东西

假设屏幕由各种像素构成，像素是内部颜色不变的小方块

为什么三角形在CG中广泛应用：

* 是最基础（边最少）的多边形
  * 其他多边形可以拆成三角形
* 独特的性质
  * 三角形三个点一定在一个平面
  * 三角形内部外部定义的很清楚（多边形可能有洞，或者不是凸多边形）
    * 向量叉积可判断在不在三角形内
  * 定义三个顶点的属性，内部可以渐变/插值（如 顶点着色器）



#### 采样方法做光栅化（简单做法）

亮还是不亮：判断像素中心点与三角形位置关系

**采样：**给一个连续函数，在不同地方取x，得f（x），把连续函数离散化

* CG中采样有很多种

* 这里是利用像素中心对屏幕空间进行采样

* > CT，核磁共振显示人体信息，也用到了采样

* 采样像素中心的inside函数，在三角形里=1，三角形外=0    p35

* inside实现：叉积，若全在向量左边/右边，该点才在三角形内   p41
* 若点在三角形边界：CG中要么不处理，要么特殊处理
  * 本课不处理，自己定一个标准（算/不算） 即可
  * OpenGL，DirectX ：  上边/左边   算， 否则不算



### 加速光栅化：

需要采样每个点吗？

* 三角形包围盒，
  * 轴向包围盒（aabb：axis-aligned（对齐） bounding box）（x，y轴，取最小和最大）
  * 每一行最左和最右作为包围盒   适用于扁长型



### 实际光栅化

* iphone
* 三星：Bayer pattern  分布方法，让红绿蓝均匀分布在屏幕上
  * 绿色更多：人眼对绿色更敏感
* 彩色打印：颜色越多越黑    rgb颜色越多越白
* 本课程认为像素是颜色一致的小方块



锯齿：jaggies

采样率低，走样（aliasing)

目标：反走样，抗锯齿



## [作业1](https://blog.csdn.net/2301_79799657/article/details/142470182)



## Lecture 06 光栅化2（反走样和深度缓冲）

主要是反走样，  z信号处理

光栅化：采样

上节课

* mvp变换后：视口变换   【-1，1】^3 映射到屏幕上 （光栅化）
* 光栅化： 像素中心进行采样    这样理解方便理解走样成因

 这节课

* 走样
* 遮挡 / 可见性



### 反走样

antialiasing

* 采样理论
* 怎么处理：抗锯齿/反走样

锯齿的学名：走样



#### 采样理论

* 采样广泛存在：视频通过时间采样→图片

* 采样产生的问题也广泛存在：
  * artifacts 瑕疵     CG里一切不准确的错误
    * 楼梯状锯齿 															空间
    * 摩尔纹 ：删除奇数行和奇数列   比如手机拍电视屏幕   空间
    * 车轮倒转：眼睛采样跟不上速度                              时间
    * 前两种：空间，第三种：时间
* 总结：
  * 本质：信号变化太快，采样速度跟不上，产生artifacts（走样）
  * 通过频率分析



### 如何反走样

分析结果及为什么

采样前：模糊blurring   /  预过滤pre-filter：去掉高频信号

先模糊后采样 antialiasing

先采样后模糊 blured aliasing

why？p26



####  频域

frequency domain 频域

周期T：每隔T重复一次     f=1/T



#### 傅里叶级数展开：

* 把方波函数，描述为很多余弦/正弦 的和，由低往高 加     p30



傅里叶变换：f（x）→F（x）     逆傅里叶变换：F（x）→f（x）

* 函数变成不同频率的段，并显示出来
* 间隔一段对函数进行采样  p32    采样频率和函数频率有关系



通过频率分析走样：

* 相同采样方式采样两种不同函数却无法区分（走样概念）



滤波filtering

* 把特定频率给删掉



#### 傅里叶变换： p35

* 把时域（认为空间不同位置也算，一个名字罢了）→频域    （即 图像空间变到频率空间）

* 中心定义为低频，周围定义为高频，信息越多亮度越大

* 图片：一般低频信息集中在中间，很多，高频信息很少

  > 为什么有横竖两条线？（为了分析内部问题，可忽略这两条线）
  >
  > 认为信号是周期性变化的
  >
  > 不重复的图片，认为水平方向叠了很多，上下叠了很多，
  >
  > 图搬到右边：左边界和右边界叠在一起（一般边界不同），发生剧烈信号变化产生极其高的频率变化*

* 让我们看到任何信号在不同频率长什么样（**频谱**）



高通滤波：只有高频可以通过      逆傅里叶变换：频域→图像

* 分析：高频信息对应边界why
* 上下/左右 发生突变（剧变）→高频信息

低通滤波：只留下低频信息（相同色块），边界看不到了



越高频越边界  （数字图像处理课程）以前是用频率/ 滤波处理图像，现在是机器学习



滤波

=平均（只留下低频→模糊（一种平均操作））

=卷积



* CG角度的卷积（简化后的定义）：p42

一维信号：一维数组

某种滤波器/卷积核（滑动窗口）在一个范围加权平均再放在中心， 最后得到一个新的信号result



#### 卷积定理      

直接下结论

时域spatial domain 的信号卷积==频域frequency domain上两个信号的乘积 p45

1-时域上卷积

2-时域转化为频域，频域相乘，再转化为时域

时域的信号卷积==频率上两个信号的乘积

频率卷积==时域的乘积



* 乘以1/9的原因——对处理结果进行归一化：卷积操作时原图像中的9个像素卷积盒中的元素分别相乘再相加，得到的是原来的9倍，会导致图像异常明亮。

* 卷积盒是低通滤波器的原因：卷积核box-filter经过傅里叶变换后，可以发现它大都是低频信号。



盒子在时域上就是一个小格子，时域（就是空域）上变大 → 频域上变小

Why：卷积盒尺寸越大，参与模糊的信息越多，就越模糊，频率越小。



采样(Sampling)：采样把原频谱复制粘贴，就是重复原始信号的频谱

![img](https://picx.zhimg.com/80/v2-38eb1cce00c851f54581db4b8b3e878d_720w.webp)

为什么会走样？

#### 走样的本质

采样不够快， f变小→中间间隔小 →信号混在了一起（频谱混叠/ 走样） p51    理解：采样得越多，越精确

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/ac15536f36ebf20de55d21cb025a2fde.png#pic_center)

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/dd6ea0ae731ff4645ccfc20ef0197e55.png#pic_center)

#### 怎么反走样

* 提高采样率
  
* 设备上解决（不算反走样）：增加采样率（增加分辨率）——像素点像素小→像素点间隔小→采样率频率高→频谱间隔大
  
* 反走样

  * 先模糊，再采样

  * 使用低通滤波器进行卷积，截去高频信号，这样原信号最大限度保留原有的样子，又缩小间隔，不会发生混叠，进而达到反走样的目的。

    ![img](https://pic4.zhimg.com/80/v2-b47e823cb0b4b80361e89ae76591da93_720w.webp)

    * Q：实际操作中，怎样用滤波器进行模糊操作呢？（怎样进行滤波）

      A：一定大小的滤波器对其进行卷积，三角形对它覆盖的每个像素，求覆盖面的平均值

#### SSAA超采样反走样 

- 提升分辨率直接解决走样问题

- 把每个像素点都进行细分，比如可以分成4个子采样点，然后针对每个子像素点进行着色运算，最后根据每个子像素的值来合成最终的图像。显然采样点越多抗锯齿效果越好，但是计算负担会增加
- [超采样技术](https://zhida.zhihu.com/search?q=超采样技术&zhida_source=entity&is_preview=1)就是以一个更大的分辨率来渲染场景，然后再把相邻像素值做一个过滤（比如平均等）得到最终的图像（Resolve）

#### 多重采样MSAA

多重采样 MSAA（ Multi Sampling Anti-Aliasing）：把每个像素点都进行细分，比如可以分成4个子采样点，每个小像素也有各自中心点，**根据小像素在三角形内个数得到覆盖率**，再通过覆盖率算出这个像素对应的颜色（求覆盖面的平均值）

MSAA实际上解决的是对图形进行模糊操作的这个过程，他只是通过近似的一种方法进行模糊，只是增加采样点并没有提高屏幕分辨率。



工业界：   FXAA / TAA

不规则的区域去采样

*  FXAA

快速近似[抗锯齿](https://zhida.zhihu.com/search?q=抗锯齿&zhida_source=entity&is_preview=1) FXAA（Fast Approximate Anti-Aliasing），他是一种和采样（增加样本数）无关，在图像层面做的处理，

处理过程：是先找到三角形的边界，把有锯齿的边界替换为没有锯齿的边界，而且处理起来非常快（边缘检测算法）

* TAA   （Temporal时间的，不翻为暂时性）

时间抗锯齿 TAA（Temporal时间的，不翻为暂时性 Anti-Aliasing），最大的特点就是非常快速，是将静态的图片在时间上进行采样，相连两帧显示的图像是一样，但是可以用相邻两帧同一个像素上不同位置的点来感知是否在三角形内，计算的时候要考虑上一帧感知的结果要被应用进来，相当于是MSAA对应的样本分布在时间上，并且当前这帧没有任何额外的操作

* ### DLSS

  和抗锯齿不一样，但和MSAA本质相似：解决样本不足的问题

  深度学习超分辨率采样 DLSS （Deep Learning Super Sampling）

  小图拉成大图→细节缺失（或采样率不够，想恢复高分辨率的图）

  用深度学习猜缺失的细节

  > 深度学习很擅长猜



参考笔记：

1-[Games101计算机图形学入门（5）Rasterization —— 深度测试与抗锯齿 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/567867496)

2-[Games101_06_Rasterization(Antialiasing and Z-Buffering) - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/376787901#:~:text=时域与频域有对称关系•方法一（时域上的乘积）：a x c = e，原始信号a x)

鸣谢前人做出的努力，让后来者可以降低学习成本（在已有基础上加上自己的理解自然比从0开始成本小得多）



先采样后模糊不行，why：

采样后频谱已经无限复制粘贴且发生混叠了，没办法简单地切掉混叠处了，而且丢失的信息太多了



### 可见性 / 遮挡 问题

* 解决办法：**Z - Buffer  深度缓冲**

如何把一堆三角形画在屏幕上，并且遮挡关系是对的

（油）画家算法：先画远的，再画近的 — 先把远处的物体进行光栅化，再对近的进行光栅化，然后覆盖掉

<img src="https://pic1.zhimg.com/80/v2-b4b9e4fc63a0abeabee42471c52f18ba_720w.webp" alt="img" style="zoom:50%;" />

（这种情况不好对三角形的远近顺序进行排序，无法定义深度关系，后画的一个永远没被覆盖 WA，于是出现了Z-Buffer/深度缓冲）

- **对每个像素**进行远近排序
- 同步生成两个东西：frame buffer（存最后的结果），depth buffer（任何一个像素对应的深度  存在z-buffer里）
- 变换中：相机放在原点，往-z看，且z为负的；这里为简化计算，离摄像机越近，深度（点到相机距离，正数）越小；越远，深度越大（图片的结果：越近越黑，越远越白（深度越大灰度越高→白，颜色值越小越黑），0-1 — 黑-白）

<img src="https://pica.zhimg.com/80/v2-93bcaabe1e48aaca4beef0ee11d2da78_720w.webp" alt="img" style="zoom:50%;" />

#### 算法：

1. 深度缓冲里一开始记录的深度都是无限远
2. 一个个三角形光栅化成不同的像素
3. **对每个三角形的每个像素进行遍历，如果像素的深度z小于缓存里（x,y）的深度，就把缓存里（x,y）该点位置的深度更新为该像素的深度z，并同时更新该像素点（x,y）的颜色为三角形面上该点的颜色。**

<img src=".\CG入门img\v2-04cd5e1a3cc8dcf691bf6e048b734a16_720w.webp" alt="img" style="zoom: 50%;" />

<img src=".\CG入门img\v2-09d779c7924e255a1ae76e6865ad3ab8_720w.webp" alt="img" style="zoom:50%;" />

R：无限大 

 假设不会出现两个不同的三角形在一个像素上有同一个深度的情况（依据：CG中很多数字用浮点型表示，浮点型与浮点型判定相等是几乎不可能的），**性质：深度缓存与顺序无关**，即两个三角形画的先后顺序不影响最后结果



**Z-Buffer处理不了透明物体的深度**



[如果看了这篇文章你还不懂傅里叶变换，那就过来掐死我吧（二） - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/19763231)

（在时域中做不到的数学操作，在频域中很简单，这里就需要傅里叶变换）

- 时域是信号在时间轴随时间变化的总体概括。
- 频域是把时域波形的表达式做傅立叶等变化得到复频域的表达式，所画出的波形就是**频谱图**。是描述频率变化和幅度变化的关系。





## Lecture  07  着色1（光照与基本着色模型）

### Shading着色

- 字典Definition：通过用平行线或色块引入明暗和颜色的不同
- 本门课程定义：
  - 对不同的物体应用不同材质的过程，
  - 理解：不同材质与光线相互作用不同→看上去各不相同，我们为什么能看到物体：人眼接收到了物体来的光。

<img src="https://pic2.zhimg.com/80/v2-2b594c965b6d48c6402f244b81bc48fd_720w.webp" alt="img" style="zoom:50%;" />

### Blinn - Phong 反射模型

是最基础的着色模型

#### 物体上三部分光：

高光，漫反射，环境光（Ambient lighting）-间接光照

```text
Specular highlight 高光
Diffuse reflection 漫反射
Ambient lighting 环境光照
```

* 漫反射：光会被均匀的反射到不同的方向
* 高光：光滑部分
* 环境光：间接光照（ 通过墙面 / 桌面/ 环境反射）



#### 定义光照相关的变量

<img src="https://picx.zhimg.com/80/v2-76ebdffcc3117ff661b9ceb090ffbfbd_720w.webp" alt="img" style="zoom: 80%;" />

V 观测方向 （方向：即单位向量）

N 平面法线方向

I 光照方向

各个点不同的表面属性(color，shininess（有多亮）)



Shading是一个局部概念，考虑这个点的着色情况，就只看自己，不考虑这个点是否在阴影内（即不考虑是否被遮挡，光线相对自己的方向）（**Shading ≠ Shadow**）



#### 漫反射

* 是光从一定角度入射之后从入射点**均匀地向四面八方反射**，即每个不同方向反射的光的强度相等。
* 光照
* 产生漫反射的原因是物体表面的粗糙，导致了这种物理现象的发生。

<img src="https://pic1.zhimg.com/80/v2-192f8bede97220c7e3f18a6f12dddb62_720w.webp" alt="img" style="zoom: 50%;" />

#### Lambert余弦定律：

—— Shading Point 单位面积吸收了多少光

* 光线的角度接收到的能量 与 光线方向和法线方向的夹角的余弦成正比

- 只有当入射光线与平面垂直的时候才能完整的接受所有光的能量
- 光线方向与法线方向都是**单位向量**，将其进行点乘 → n · l = **cosθ**

<img src="https://pic4.zhimg.com/80/v2-f24693bd1c8dc575807e282483d3212d_720w.webp" alt="img" style="zoom:50%;" />



点光源的衰减关系：

<img src="https://pic2.zhimg.com/80/v2-70a9f19a2ad41a2510989460508efb39_720w.webp" alt="img" style="zoom:50%;" />

- 根据**能量守恒**，球体表面积4πr²（ I：光照强度）    考虑三维空间

- - 4π * 1 * I = 4π * r² * I1，得出I1 = I / r ²

- **光照强度与距离的平方成反比**，由此可得，**知道Shading point离点光源的距离，就知道有多少光真正传到shading point附近了**

- 点光源，距离近的地方光照范围小强度高，距离远的地方光照范围变大，根据能量守恒定理，能量不变，但S变大，光照强度变小



#### 漫反射diffuse计算

- max（0，夹角）：当光线从物体下面穿过物体，打到物体表面，才会出现n与l的点乘是负数，这种情况下没有任何物理意义，因为此时只考虑反射，不考虑折射。**所以加max，把该种情况的值直接为0（**剔除夹角大于90°的光**）**
- 漫反射与观测的位置角度没有关系 → **漫反射基本原理：其余条件相同下，人在不同方向看到的漫反射光是完全一样的**

<img src="https://pic4.zhimg.com/80/v2-3c21aa398c03950531d428dffdf528f9_720w.webp" alt="img" style="zoom:50%;" />

其中 kd 为漫[反射系数](https://zhida.zhihu.com/search?content_id=214554549&content_type=Article&match_order=1&q=反射系数&zhida_source=entity)，修改 kd 可以得到物体表面不同的颜色

I 为[入射光](https://zhida.zhihu.com/search?content_id=214554549&content_type=Article&match_order=1&q=入射光&zhida_source=entity)强，r 为光源到入射点距离，n∗l 分别是法向量和入射方向

max 是为了剔除夹角大于90°的光（负数）。

漫反射系数 kd ：表示为一个vector→RGB三通道→定义一个颜色

Lambert漫反射模型只是一个经验模型，与实际物理有差异。



## Lecture 08 着色（着色频率、图形管线、纹理映射）

Last Lecture：

* Blinn - Phong 反射模型：一定光照下，算清楚一个点是什么亮度，什么颜色

  * 考虑漫反射项
  * 高光项
  * 环境光项

* 注意：

  * 着色：在一个着色点上； 得一整张图：着色很多次→着色频率

  * 方向：即**单位向量**；从着色点出发

    * V 观测方向 

      N 平面法线方向

      I 光照方向（着色点指向光源）

      各个点不同的表面属性(color，shininess（有多亮）)

  * 漫反射项从照射点往四面八方均匀地反射，和观测方向v没有关系ans

    * kd漫反射系数，代表本身颜色（灰度）/亮度



### 高光项：

比较光滑，没镜子那么光滑，则沿镜面反射方向有一个分布

产生高光的条件如下：

```text
1.光滑的表面
2.观察方向接近镜面反射方向
```

<img src="https://pic1.zhimg.com/80/v2-65b24067d951c986f9aff140c44e4ccc_720w.webp" alt="img" style="zoom:50%;" />

半程向量h：入射L与视线v夹角一半方向上的一个单位向量

- 求半程向量h：l与v的角平分线方向（平行四边法则）,再做归一化，将长度变成1
- **观察方向V与镜面反射方向R** 足够接近时 说明了 **法线方向n和半程向量h**很接近
- Ks[镜面反射系数](https://zhida.zhihu.com/search?content_id=177091332&content_type=Article&match_order=1&q=镜面反射系数&zhida_source=entity)：因为是高光，通常认为是白的 （亮度or灰度）

> * 没有考虑吸收多少：
>   <img src="C:\Users\86138\AppData\Roaming\Typora\typora-user-images\image-20241001135905455.png" alt="image-20241001135905455" style="zoom:50%;" />
>
>   因为是经验模型，所以简化了，只在意是否看到高光
>
> * 是一个改进，半程方向比反射方向（phone模型）好算
>
> * **加上指数p - 用来控制高光范围**：离**镜面反射方向R** 越远就越不应该看见反射光，需要一个指数p加速衰减（高光亮但是小（范围小）） —— power的节点的用处
>   <img src="https://pic3.zhimg.com/80/v2-94f1902997544721654994ce1e740e3e_720w.webp" alt="img" style="zoom: 80%;" />
>    指数p的作用：控制高光的大小，一般用100~200→ 3~5度之外就看不到高光了



### 环境光照项：

很多光线弹射多次，从四面八方打到任意一点上

- 大胆假设任何一个点接收来自环境的光永远都是相同 的，Ia→ 简化
- 环境光是一个常数 -- 某一个颜色

> 和入射方向L，观测方向v，法线无关

作用：提升一个亮度，保证没有地方完全是黑的

<img src="https://pic2.zhimg.com/80/v2-5cbdb23faa2897017120a5b680a8dcf7_720w.webp" alt="img" style="zoom: 50%;" />



### Blinn-Phone反射模型：环境光+漫反射+高光反射

（经验模型，不是基于物理的光照）

<img src="https://picx.zhimg.com/80/v2-7b9abe621514075fa13a3799c79c4e59_720w.webp" alt="img" style="zoom:50%;" />

Q&A

物体到观测点离多远没关系，而光源到物体有能量损失



### Shading Frequencies（着色频率）

着色模型

- 下图分别对应着色应用在平面，顶点，像素的效果。

<img src="https://pic2.zhimg.com/80/v2-dd3b8dcbc85568c276a70ae986ab9ee7_720w.webp" alt="img" style="zoom:50%;" />

#### 正规定义

**1.Flat Shading逐面着色：**面为着色单位，每个三角形是个平面，[叉积](https://zhida.zhihu.com/search?content_id=177091332&content_type=Article&match_order=1&q=叉积&zhida_source=entity)求每个三角形法线，根据Blinn-Phone模型计算着色，将颜色赋予整个面

<img src="https://picx.zhimg.com/80/v2-ebeac03b43a259ce940b133a1ab007f7_720w.webp" alt="img" style="zoom:50%;" />



**2.Gouraud Shading 逐[顶点着色](https://zhida.zhihu.com/search?content_id=177091332&content_type=Article&match_order=1&q=顶点着色&zhida_source=entity)：**求任意一个顶点的法线，每个顶点做一次着色，三个顶点构成一个三角形，三角形内部颜色通过[插值方法](https://zhida.zhihu.com/search?content_id=177091332&content_type=Article&match_order=1&q=插值方法&zhida_source=entity)计算得到

<img src="https://pica.zhimg.com/80/v2-c45e7a661e70f4094a8f611aad092cd4_720w.webp" alt="img" style="zoom:50%;" />

（插值   Interpolate）



 **3.Pone Shading逐像素着色：**求出三角形的三个顶点的法线，然后三角形内部每个像素都插值出一条法线方向，对每个像素进行一次着色（时间开销大）。

1. >  Phone反射是高光反射，Phone着色是逐像素着色



Q&A    

* 图形足够复杂时（面数增加，三角形分的更细更小），可以采用简单的比如逐面着色，效果不一定差，效率不一定更高
  <img src="https://pica.zhimg.com/80/v2-63dfe968a1cd184590b76ac151f9c07c_720w.webp" alt="img" style="zoom:50%;" />

* **每个顶点的法线求法：将顶点所关联的面的法线向量加起来求平均（简单平均/加权（权：三角形面积）平均），最后再归一化就得到了该顶点的法线向量了。**

<img src="https://pic1.zhimg.com/80/v2-9bf19907930c94dbf6c2e78cdb00a632_720w.webp" alt="img" style="zoom:50%;" />

* 怎样插值出像素的法线呢？
  所求的法线即方向，方向是单位向量

  要用到重心坐标



### 图形管线 （实时渲染管线）

管线：一系列不同操作从场景到最后一张图

* 投影
* 光栅化（采样，z-buffer）
* 着色

<img src="https://pic3.zhimg.com/80/v2-ab59fcdd77f6f74cec7741238bdddab6_720w.webp" alt="img" style="zoom:50%;" />

fragments 可类比为像素

- 着色：主要是顶点或者像素着色 ，现代GPU中渲染管线该部分可编程
- Shader：控制顶点和像素是如何进行着色的代码
  - 每个顶点/像素都会执行一次（通用的，不用for循环）
  - 顶点shader：顶点着色器
  - 像素shader：像素着色器   
    - 像素/fragment片段，说的一回事
  - GLSL（OpenGL Shading Language）是一种用于OpenGL图形程序的高级着色语言
    <img src="https://pic2.zhimg.com/80/v2-35223b99e98eb88775ee8997737e52af_720w.webp" alt="img" style="zoom:50%;" />



### GUP

- 独显/核显**（集成显卡）**
- gpu可以理解成高度并行化的处理器（核心数量理解为[并行线程](https://zhida.zhihu.com/search?content_id=214779026&content_type=Article&match_order=1&q=并行线程&zhida_source=entity)的数量）
- gpu并行度惊人，远超过cpu



### 纹理映射

> 7.4.1 纹理(Texture) 7.4.2 纹理坐标UV 7.4.3 特殊纹理tile

思路（1）：**希望在物体不同位置定义不同属性 **→ 引入纹理映射

思路（2）：怎么定义任何一个点的基本属性呢？

* 物体的表面是2D的，也就是说可以将三维物体上的任意一个点都映射到一个2维平面（纹理，就是一张图）之上 （立体空间三角形的顶点已经规定了坐标）

<img src="https://pic2.zhimg.com/80/v2-2f1b5e13b071fbe20419e4eed6185273_720w.webp" alt="img" style="zoom: 50%;" />

* 参数化：
  * 物体各处无缝衔接，映射的纹理的颜色也无缝衔接（几何方面很重要的研究方向）



#### 纹理坐标系 —— UV

<img src="https://pic3.zhimg.com/80/v2-17adfebef149ea3db050821b900a87be_720w.webp" alt="img" style="zoom:50%;" />

U/V范围一般[0,1]（约定俗称，方便处理）

* 对每个光栅化的屏幕坐标算出它的uv坐标(利用三角形顶点[重心坐标](https://zhida.zhihu.com/search?content_id=214779026&content_type=Article&match_order=1&q=重心坐标&zhida_source=entity)插值)，再利用这个uv坐标去查询texture上的颜色，把这个颜色信息当作漫反射系数Kd。
* 一个点/像素 →（通过重心坐标插值）uv → 查询找到对应texcolor代替kd



#### 特殊纹理tile

<img src="https://picx.zhimg.com/80/v2-da67bef0a3bbf20e52ebffbfe6310db1_720w.webp" alt="img" style="zoom:50%;" />

tile纹理有上下左右重复拼接都是连续的特性，多用在贴在墙面或地板上。



*思路（3）*：知道了三角形三个顶点对应的纹理坐标，那么如何知道三角形内部的点对应的纹理坐标位置呢？

插值通用解释：三角形三个顶点有各自不同的属性，如何把这个属性在三角形内部做一个平滑的过渡

（下节重点讲插值，采用到[重心坐标](https://zhida.zhihu.com/search?content_id=177091332&content_type=Article&match_order=1&q=重心坐标&zhida_source=entity)）



Q&A

- 纹理与着色的区别和关系：纹理是用来定义着色的时候需要的各个不同点的属性，不希望着色的时候每个点以相同的属性来着色
- 着色和材质基本没什么区别，不同材质就是不同的着色方法



## 09 着色（插值、高级纹理映射）

### today

* 重心坐标做插值

* 纹理怎么贴在物体表面

* 纹理其他应用



如何在三角形内部做插值？ ——

### 引入重心坐标

重心坐标

- **Why do we want to interpolate（插值）?**
  * 很多操作是在三角形顶点上完成/计算的，并且希望值是平滑过渡的


* 重心坐标是定义在三角形上的，一个三角形对应一个重心坐标

* 三角形平面上任意一个点都可以用一个线性坐标来表示（x, y）= αA + βB + γC，只要满足**α+ β+ γ = 1(** **重心坐标要求，为了限制所求的点在三角形平面内)** 

  重心坐标（α，β，γ ）

* 点在三角形内部，α、β、γ都必须是非负的
* A点自己的重心坐标 —— （1,0,0）；   易得B（0,1,0），C（0,0,1）

<img src="https://pic1.zhimg.com/80/v2-c38d1f0a9f2447b902840fcb9c50fc60_720w.webp" alt="img" style="zoom:50%;" />

 

- **重心坐标的另外一个定义：可以通过面积比求出来**

<img src="https://pica.zhimg.com/80/v2-ca0b72426b92474d52c8be81abedd84e_720w.webp" alt="img" style="zoom:50%;" />![img](https://pic1.zhimg.com/80/v2-e58d617f2213f3d156461f78c48b4d5c_720w.webp)![img](https://pic1.zhimg.com/80/v2-e58d617f2213f3d156461f78c48b4d5c_720w.webp)

- **如何求重心坐标？**   知道定义&&可以算即可

<img src="https://pic1.zhimg.com/80/v2-e58d617f2213f3d156461f78c48b4d5c_720w.webp" alt="img" style="zoom:50%;" />

> 例子
>
> 假设我们有一个三角形ABC，其顶点坐标分别为A(0,0)，B(1,0)，C(0,1)。现在我们想要确定这个三角形内部某一点P的属性值，比如颜色或者纹理坐标。假设顶点A、B、C的颜色分别为红色(1, 0, 0)，绿色(0, 1, 0)，蓝色(0, 0, 1)。
>
> 首先，我们需要找到点P的重心坐标(λ1, λ2, λ3)，其中λ1 + λ2 + λ3 = 1。假设点P的重心坐标为(0.25, 0.25, 0.5)，**这意味着P更靠近顶点B和C**。
>
> 接下来，我们使用这些重心坐标来插值P的颜色值。插值的公式如下：
>
> P的颜色 = λ1 * A的颜色 + λ2 * B的颜色 + λ3 * C的颜色
>
> 将重心坐标和顶点颜色代入公式：
>
> P的颜色 = 0.25 * (1, 0, 0) + 0.25 * (0, 1, 0) + 0.5 * (0, 0, 1) = (0.25, 0, 0) + (0, 0.25, 0) + (0, 0, 0.5) = (0.25, 0.25, 0.5)
>
> 所以，点P的颜色是紫色(0.25, 0.25, 0.5)。

* 问题：投影变换不能保证重心坐标不变，因此三维空间的属性在（投影前）三维空间中求重心坐标，做插值  。 再把结果对应到二维
  * 比如深度



### 应用纹理

把纹理应用到实际渲染中

<img src="https://pic4.zhimg.com/80/v2-23b635ec163dc146432c7b95f47d4d51_720w.webp" alt="img" style="zoom:50%;" />

每个点/像素，通过重心坐标插值得到（U，V），再查询每个（U，V）坐标对应的纹理位置，取出，直接用





#### 纹理太小：

Nearest Point Sampling（就近纹理采样）

* 问题：屏幕分辨率太大而纹理太小，把小数四舍五入为整数
* 解决：放大，做插值
* 纹理上的像素texel：纹理元素 / 纹素
  * pixel 像素<img src="https://pic4.zhimg.com/80/v2-f506e43d642f575e56c471995c816d23_720w.webp" alt="img" style="zoom:50%;" />![img](https://pic2.zhimg.com/80/v2-7f3c77cfcd4bc6bb71566d2246d4590d_720w.webp)
  * <img src="https://pic2.zhimg.com/80/v2-7f3c77cfcd4bc6bb71566d2246d4590d_720w.webp" alt="img" style="zoom:50%;" />
    四舍五入→很多像素映射到同一个整型的纹素上



##### 双线性插值：Bilinear

<img src="https://pic2.zhimg.com/80/v2-abd132c4b4e8754b79887256e0cafae8_720w.webp" alt="img" style="zoom:50%;" />

* 水平方向插值 → 得到两个点
* 竖直方向插值 → 得到一个点

最后综合考虑了四个点

> (水平u00,u10插值一次，水平u01,u11插值一次得到v0,v1的颜色值，但是要求的是红点的位置，于是垂直方向对v0,v1做一次插值求出红点)

**思想：想要画面平滑过渡，就找该点周围四个像素的值做水平，垂直方向的插值，综合考虑了周围四个点的颜色，能很好地缓解走样失真现象**

<img src="https://pic1.zhimg.com/80/v2-87f43b90c723394e404c979891323a06_720w.webp" alt="img" style="zoom:50%;" />

**Bicubic**（双向三次插值）：取的是邻近16个像素，每次对四个进行三次的插值



#### 纹理太大 —— 走样

<img src="https://pic4.zhimg.com/80/v2-5578793c007794b163d74b0dbe54421f_720w.webp" alt="img" style="zoom:50%;" />

（远处摩尔纹，近处锯齿）

- **原因：**远处一个像素覆盖了一大片纹理（一个像素中心点代表一大片区域的平均值）

- > 解释：
  >
  > 纹理中每个格子所占用纹理像素个数是固定的，比如nxn。在屏幕中因为投影的关系近处的格子放大，会有更多的屏幕像素来表示一个格子比如8nx8n，这导致屏幕上的多个像素对应纹理上的一个像素，根据前面的Nearest Point Sampling可知锯齿情况发生。而在远处屏幕上的一个像素可能覆盖纹理上的一大片像素，多个texel 会被一个pixel采样，且随着距离越远，texel数量越多。即一个采样点内信号变化过高，导致摩尔纹走样。

- 希望把高频信息重构出来

- **做法：** ①超采样 **（计算量大）②不采样 - Mipmap**



> 纹理就像是贴在三维物体上的表皮，像素是投影到屏幕上的显示的小块

* 点查询，给一个点，查纹素值
* 范围查询：
  * 给一块区域，快速地求平均值 / 最大值 / 最小值

#### MipMap

做范围查询 —— 快，近似（不准），**仅仅是正方形的范围查询**

拉丁语：mip 很多小东西合到一块

从一张图生成一系列图（预先计算好），从level0（nxn）往上，每一层长宽缩小1/2，面积缩小1/4

<img src="https://pic1.zhimg.com/80/v2-9ae77f6638e40daa7be2729c72d43f38_720w.webp" alt="img" style="zoom:50%;" />

有多少层？每次边长变为**原来的1/2，所以有Log2n层。一共需要三分之四的存储量，只是比原来多了⅓的存储量（等比数列求和）**

（计算机视觉中把mipmap叫图像金字塔）

"Mip Hierarchy" 翻译为中文是“MIP 层次结构”或“MIP 映射金字塔”。

- 如何确定渲染的Mipmap的层级图?

我们如何知道某个屏幕像素应该使用哪个层级的纹理呢。我们找到屏幕像素邻近的四个像素组成的区域，边长为1个像素；映射到0级纹理上的近似正方形区域，我们可以求出近似的边长L。则层级D = log2（L） 。

<img src="https://pic1.zhimg.com/80/v2-b46d12efffc8a488105154312d0fb928_720w.webp" alt="img" style="zoom:50%;" />

* ①求红点，找出红点邻近的像素点。分别查询他们对应纹理空间中的坐标

* ②用一个近似的正方形来表示他们的不规则区域范围

  * *怎么知道相邻像素点映射到纹理上，点与点之间的距离呢？*

    * **算微分**（知道屏幕上的点从（u，v）00移动到（u，v）10的距离，那它在纹理中（u，v）00移动到（u，v）10的距离）（猜是雅可比行列式做坐标变换，**注：dx，dy=1**）
    * 点到不同点之间的距离会不一样，简单起见就在它们之间取最大的值

    

  * *近似成一个正方形之后，如何去根据Mipmap来查询边长为L的区域值的平均值？*

    * L x L 的区域在D=Log2L层上对应1x1像素
    * 在D=Log2L层查询，然后就可以得出这个区域的平均值大小
    * 离屏幕越近的区域，用越低层去查询；离得远的用高层去查询（理解：因为离屏幕越远的地方，一个像素对应一片纹理区域；在Mipmap中越高层才可能一个像素近似一个区域）

参考：[六、纹理映射（图形渲染系列） - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/369498677)



* 怎么让层之间平滑过渡？**Trilinear Interpolation(三线性插值)**
  插值：先找第一层，再找第二层，然后第一层双线性插值，第二层做双线性插值，这两层的值再来一次（层与层之间）插值 —— 三线性插值（广泛应用，使得层与层之间是连续的；开销：两次查询，一次插值）

  <img src="https://pic4.zhimg.com/80/v2-c1411f89e718083908572ecff2619c83_720w.webp" alt="img" style="zoom:50%;" />

<img src="https://pica.zhimg.com/80/v2-a64f06ab62b4a2b7fc241ff0675bbb58_720w.webp" alt="img" style="zoom:50%;" />



**缺陷：过渡模糊Overblur** 

- 因为插值是近似的，正方形也是近似的



解决方法：

#### ①各向异性过滤（还有个名字叫Ripmap）

- 比mipmap多了不均匀的水平/垂直上的压缩
- **各向异性：在不同方向上表现各不相同**

<img src="https://pic1.zhimg.com/80/v2-b21e5770c8031c67fafbd281552af8ba_720w.webp" alt="img" style="zoom: 67%;" />

>  <img src="https://pic3.zhimg.com/80/v2-8125393739c7a1349edf7c30e7a6e804_720w.webp" alt="img" style="zoom:50%;" />
>
> （屏幕上的正方形映射到纹理上不一定是正方形，有可能是变形的，有的所需要的是仅仅是水平方向的高level，有的需要的仅仅是竖直方向上的高level。这时候用mipmap的近似正方形去查询，就会出现过渡模糊，因此这也就启发了各向异性的过滤）

“多少X”是指计算几层，2X，就是计算左上角2x2的区域；4X  ，压缩三层；

<img src="https://pic4.zhimg.com/80/v2-fc0a832ba4969949c5d0de799f75b41f_720w.webp" alt="img" style="zoom:50%;" />

- 各向异性过滤允许我们对长条形的区域做一个快速查询，但是对斜着的效果还是不好
- 选的层数越高，**存储量最终都收敛到原来的3倍**（也就是说打游戏的时候，开各向异性过滤，尽量都开到最高层）只对显卡内存开销有一点要求



②EWA过滤

- 把不规则的形状，拆成很多不同的圆去覆盖这个区域
- 代价是多次查询（质量越好，代价越大）



### 纹理其他应用

概述：

一块数据，点查询 / 范围查询很快

<img src="https://picx.zhimg.com/80/v2-1d989ed0c7338c70912fb383222575bd_720w.webp" alt="img" style="zoom:50%;" />

#### 环境光照（贴图）

环境光照/环境贴图：把四面八方的环境光记录下来，然后用来渲染其他物体

* 纹理可以用来表示环境光

* 这里假设环境光来自无限远（只与观察方向有关，与距离无关）



* 环境光/环境贴图可以记录在球面上，并且把它展开

  <img src="https://pica.zhimg.com/80/v2-cf1c452cce0cf8d0b32899b311d8abd4_720w.webp" alt="img" style="zoom:50%;" />

* 但是有个问题：扭曲，不是均匀的描述环境光

<img src="https://pic4.zhimg.com/80/v2-880c4f9192626d65ffc9adc69716910f_720w.webp" alt="img" style="zoom:50%;" />

* 解决：cube map

  * 用一个立方体当作包围盒，把球包住，一共6张图，再做一些额外计算判断在哪个面上

  * 连接球心和球面上地一个点，并作延长线，让球面上的点映射到立方体的表面。
  
    ![img](https://i-blog.csdnimg.cn/direct/6282d3102cba4c278f9d1be9f7fff0fd.png)
  
  * 映射结果如下，在业内也被称为“天空盒”
  
    ![img](https://i-blog.csdnimg.cn/direct/d83e0e899cb54c909522ccc25ace7a16.png)

> 看到任何物体都是因为有光从他到达了眼睛



#### 1-法线贴图/ 凹凸贴图（Bump Mapping）

基本原理：纹理记录高度→虚拟地改变相对高度→法线变化→明暗变化，让人看起来有凹凸变化

* 通过法线贴图，可以定义一个复杂纹理，但是不改变几何信息

* **如何去计算法线应当如何变化？(2D)**

* - 假设原本法线是向上的，（0,1）

  - [差分方法](https://zhida.zhihu.com/search?content_id=177091524&content_type=Article&match_order=1&q=差分方法&zhida_source=entity)计算切线

  - - 凹凸贴图定义切线

    - 相邻两点高度差，除间隔（1），与一个常数c相乘(决定凹凸贴图的影响是否大)

    - - dp = c * [h(p+1) - h(p)]
      - （常数c：放缩，定义凹凸贴图的影响）

  - 通过切线求法线（法线垂直于切线）：切线逆时针旋转90°得到法线

  - 归一化

<img src="https://pic4.zhimg.com/80/v2-f5f74ed96267929a62f236e6ff0e5b93_720w.webp" alt="img" style="zoom:50%;" />

 求法线：用到了高数知识

![img](https://i-blog.csdnimg.cn/direct/389a4a3ca6fe41069ca270765f2a4903.png)

三维类比二维

<img src=".\CG入门img\下载.png" alt="下载" style="zoom:50%;" />

#### 2-位移贴图（Displacement Mapping）

- 与凹凸贴图用同样的纹理
- 真正移动了顶点的位置
- 代价：要求模型本身的三角形要足够细，顶点之间的间隔要比纹理定义的频率还要高
- 类比采样：完整地反应高度变化，则采样率要够高，图形要足够细致

* 动态细分：一开始稍微粗糙，位移贴图过程中 根据需求判断是否要将三角形分的更细



#### 三维纹理

定义空间中任意一点的值，定义三维空间中噪声的函数（经处理可以变成需要的样子）

- Perlin Noise定义三维噪声，应用广泛

<img src="https://i-blog.csdnimg.cn/direct/344118538f234ae2b8c5f311f654606f.png" alt="img" style="zoom:50%;" />



#### 记录已生成信息

<img src="https://i-blog.csdnimg.cn/direct/9532343db10c4c31932f80c073b762bc.png" alt="img" style="zoom:50%;" />

模型的阴影可以提前计算好，然后着色的时候直接贴上去就可以实现物体阴影。

* 着色结果 x 环境光遮蔽的纹理（  可见-1， 不可见-0 ， 中间为过渡态）



#### 体渲染

三维纹理

<img src="https://i-blog.csdnimg.cn/direct/5a672454b74f4419a13163a2bae21298.png" alt="img" style="zoom:50%;" />

参考资料：

[【GAMES101笔记速查——Lecture 09 Shading3(Texture Mapping Cont.） 】-CSDN博客](https://blog.csdn.net/weixin_45972089/article/details/142387200)





## 10 几何（基本表示方法）

### today

* 几何例子
* 几何表示方法



### 几何例子

* 不同形状<img src="https://i-blog.csdnimg.cn/direct/c1ff466aa14f4ba7b0c04cf5a7849dbd.png" alt="img" style="zoom:50%;" />

* 如何表示毛发
* 如何表示城市远景



### 几何表示方法

几何的表示方法可以分为两类：**隐式几何**、**显式几何**



#### 1 隐式表示（“Implicit” Representations of Geometry）

不给出实际点在哪，而告诉你这些点所满足的关系式。

eg:描述一个球，可以用  x^2 +y^2 +z^2=1 来约束球的形状大小。

更一般的情况，可以构造任何一个函数 f(x,y,z) =0 来表示点所满足的关系。

eg:在描述球面的时候，可以构造函数 f 让球内部的点代入表达式后的结果为负数，外部为正数，球面为0。

<img src="https://i-blog.csdnimg.cn/direct/558e3b7a93a746c188d4572d50b50dfd.png" alt="img" style="zoom:50%;" />

下面两张图说明了隐式表示的优缺点：

隐式表示的缺点：不直观，某些结果难以求解。

隐式表示的优点：容易判断任何一个点位于物体内部或者物体外部。

![img](https://i-blog.csdnimg.cn/direct/f02d3bcac2c14b3692ef6743d1b3fbeb.png)![img](https://i-blog.csdnimg.cn/direct/c1c5053b03fd44e0a1716662aed2ce5b.png)



#### 2 显式表示（“Explicit” Representations of Geometry）

常见的显式表示方法：

* 模型三角形面直接定义点的位置；



* 参数映射。（参数方程）

  定义（u,v）和函数f，将通过将二维坐标代入f，从而将二维信息映射到三维空间（x，y，z）。

  （这个形状叫马鞍面）

  <img src="https://i-blog.csdnimg.cn/direct/4df18a7a03e9455b81471dfecf464c92.png" alt="img" style="zoom:50%;" />![img](https://i-blog.csdnimg.cn/direct/cdd17ee3c30c4e81bbf4ebf4fe0320e1.png)

举个例子：这个显式方程表示了游泳圈面，其中，x,y,z项是关于u，v的函数。

<img src="https://i-blog.csdnimg.cn/direct/cdd17ee3c30c4e81bbf4ebf4fe0320e1.png" alt="img" style="zoom:50%;" />

显式表示的缺点：判断某一点在表面内还是表面外非常难。





### 几何问题没有通解

没什么好办法能完全解决几何问题，只能在实际中根据需求选择合适的。

* 不同问题适合的表示方法不同

![img](https://i-blog.csdnimg.cn/direct/989b2f1e91904087874b7b3820d78496.png)



### 隐式表示的例子

* 1-代数曲面（Algebraic Surfaces (Implicit)）

这个方法只能用代数方程表达一些简单的形状，处理过于复杂的图形很困难。不直观

<img src="https://i-blog.csdnimg.cn/direct/2954436a82d84c6c99a34d69b0e2cdd3.png" alt="img" style="zoom: 67%;" />



* 2-CSG（Constructive Solid Geometry (Implicit)）

构造立体几何，采用了集合的交、并、差运算思想，可以表示稍微复杂一点的形状。

<img src="https://i-blog.csdnimg.cn/direct/38da697d2144436a913ef59ed6517086.png" alt="img" style="zoom:67%;" />



* 3-距离函数（Distance Functions (Implicit)）
  * 目的：提取物体表面

**（1）定义**

任意几何不直接描述表面，而是描述一个点到这个表面的最短距离（可正可负）

平面空间内写出距离函数

![img](https://i-blog.csdnimg.cn/direct/26984507b8914329af5b56f692142006.png)

直接blend（融合）无法表示运动过程

距离函数**SDF：Signed Distance Function，Signed** 表示有符号，也就是有正负。

SDF 为 0 ： 点位于物体表面

SDF 为正数：点在物体的外部

SDF 为负数：点在物体的内部  

eg：有图片A和图片B，A中的灰色物体占1/3，B中的灰色物体占2/3 。

问两物体混合的中间状态是什么样的？

* 如果直接线性混合，那么就会出现1/3黑色物体、1/3灰色物体、1/3没有物体。过渡得很生硬。

* 构造A、B中灰色物体的SDF

* 然后线性混合两张图的SDF，这步操作在直观上相当于在**blend边界。**

* 然后再把blend后的构造函数SDF恢复成图片，此时，边界（SDF=0）基本处于图片中央。可以得到平滑的融合结果。

<img src="https://i-blog.csdnimg.cn/direct/716e0f58a6674fda9304da5b514680b9.png" alt="img" style="zoom:50%;" />

> 我的理解：
>
> blend（混合）的目的是求出中间状态，插一个中间帧，让变化不那么突然
>
> 如：我们取SDF_A和SDF_B的平均值来创建一个新的SDF，表示两个图像的混合：
>
> 混合SDF=SDFA+SDFB2混合SDF=（SDF*A*+SDF*B*） /2 

![img](https://i-blog.csdnimg.cn/direct/d697339d4a7e41f5b35051230a3ac640.png)

**（2）特点**

距离函数的表示能力非常强，下面这张图的很多部分都是由距离函数定义。

![img](https://i-blog.csdnimg.cn/direct/06be1f5f35284546876a061079ce3335.png)

如何从距离函数恢复到物体表面？一般来说，**求出距离函数=0的位置就是物体表面。**

**（3）水平集**

距离函数的定义方式也不局限于数学表达式，还可以用网格来存储距离信息，那么网格值为0的地方就是物体的表面了。使用这种方式可以描述一些代数表达式无法描述的复杂形状。这个概念在地理中称作等高线（不同位置上的同一个值）。

<img src="https://i-blog.csdnimg.cn/direct/734138bc7d1440febac2b1b90ab28e1f.png" alt="img" style="zoom: 67%;" />

* 当水平集定义在三维空间上的格子

![img](https://i-blog.csdnimg.cn/direct/23ad650aef7e46619307e239de11a9ca.png)

* 用水平集做物理模拟

![img](https://i-blog.csdnimg.cn/direct/3c326024752d430d84f354e8bca6dc91.png)



* 4 分型（Fractals (Implicit)）

用来描述一些具有自相似形的物体，雪花，微生物，植物，入海口形状等等。

![img](https://i-blog.csdnimg.cn/direct/92983a7b897f48d9bb57de6cb4591182.png)



### 隐式表示的优缺点

![img](https://i-blog.csdnimg.cn/direct/dca0c77ce2fd416681b76c2efafe78fa.png)

#### 优点

·描述紧凑   （一个公式即可表示，对存储有利）

·判断边界内外容易

·便于做光线和表面的相交（后面讲）

·对于简单的形状，精确的描述/无采样误差

·易于处理拓扑变化(例如，流体)



#### 缺点

·难以描述复杂形状



Q&A

3-距离函数（Distance Functions (Implicit)） √



### 显式表示的例子

<img src="https://i-blog.csdnimg.cn/direct/5a35bb65376a45a3a69d1ccc26c361c7.png" alt="img" style="zoom:50%;" />

#### 1-点云
点云的密度足够大的时候，就可以看作面了。

一般人们在做三维空间的扫描的时候，输出都是点云。

有许多研究在研究：如何把点云变成三角形面。

采样密度比较低的地方难以画出形状，比如下图中金色雕塑的下半部分。因此在现在的一些工作中，人们很少使用点云，一般都是扫描出来的原始数据是点云。

<img src="https://i-blog.csdnimg.cn/direct/482a9e5ef0714bb1bc4f9e5767e1e265.png" alt="img" style="zoom:50%;" />

#### 2-多边形网格

储存顶点和多边形（通常是三角形和四边形）。

这种方法几乎是在图形学中最广泛应用的方法。

<img src="https://i-blog.csdnimg.cn/direct/73094f8a0f934ff4a72c7381c1769896.png" alt="img" style="zoom:50%;" />

#### 3-Wavefront Object File(.obj)格式

通常用于图形研究

特定的文件格式 — .obj（和建模软件编译出来的.obj文件不是一回事），只是一个文本文件，指定顶点，法线，纹理坐标和f开头的数字组合（表示这三者之间的连接）表示三角形网格。

* 下图是立方体

<img src="https://i-blog.csdnimg.cn/direct/b11673f4488749a59f6a476e48f971af.png" alt="img" style="zoom: 67%;" />

- 

<img src="https://pic4.zhimg.com/80/v2-a7bcfcda9b74440aa0d57bb8e9b3b229_720w.webp" alt="img" style="zoom:50%;" />

* vn那不是六个是因为有冗余信息，vt最多有二十四个纹理坐标信息，因为每个面四个点，但是考虑共用顶点，就会记录<=24个纹理坐标）

* f 定义哪三个顶点构成一个三角形：f 5/1/1 1/2/1 4/3/1 —— 第5,1,4个顶点构成三角形，第二个参数是指纹理坐标，第三个参数表示第几个法线



## 11 几何（曲线与曲面）

### today

* 曲线
* 曲面



### 曲线

#### 1 贝塞尔曲线（Bézier Curves）

贝塞尔曲线属于显式表示法。（参数t）

用一系列的控制**点**来**定义**一条**曲线**。

比如下面这个例子，定义了曲线的起始点为P0，终点为P3，并且沿着P0到P1、P2到P3的切线方向走。

<img src="https://i-blog.csdnimg.cn/direct/beecfa33755c4c33a592b1406214beb3.png" alt="img" style="zoom: 67%;" />



* 如何画出贝塞尔曲线——

##### de Casteljau算法

德 · 卡斯特里奥 算法

给定**3个点**，生成的就叫做二次贝塞尔曲线

![img](https://i-blog.csdnimg.cn/direct/13202bb64d074987bc499a42119ad813.png)

<img src="https://i-blog.csdnimg.cn/direct/ba0a403e751d4ce2ab59ae80a1fa79b8.png" alt="img" style="zoom: 50%;" />    <img src="https://i-blog.csdnimg.cn/direct/15722278cd614d66b484ab6285b57e4f.png" alt="img" style="zoom:50%;" />

<img src="https://i-blog.csdnimg.cn/direct/349d0be2a7a24fdd84836a4d277d1de8.png" alt="img" style="zoom:50%;" />    <img src="https://i-blog.csdnimg.cn/direct/8196bcdce3394b3a89123913d22cdd9d.png" alt="img" style="zoom:50%;" />

这里给出了一个动画演示

<img src="https://i-blog.csdnimg.cn/direct/adbb00aca1c8454281d1f7f321b1948c.png" alt="img" style="zoom:50%;" />

以上是贝塞尔曲线的直观解释。



贝塞尔曲线——

##### 代数公式

接下来，从代数层面解析这个绘制贝塞尔曲线的de Casteljau算法。

贝塞尔曲线绘制的思路就是：在相邻点之间进行多次的线性插值，然后重复这个过程，最终得到一个值。

<img src="https://i-blog.csdnimg.cn/direct/215002df104140329e676f232b14deeb.png" alt="img" style="zoom:50%;" />

每个插值得到新点，都可以表示为关于t、已知点的一个函数。

<img src="https://i-blog.csdnimg.cn/direct/699095089eed433987a9a72aaf7ea212.png" alt="img" style="zoom:50%;" />

这个函数形式的结论也符合我们对整个绘制过程的理解：这条曲线必然是受b0\b1\b2这些控制点和t的控制的。

* **根据表达式 得出 规律总结：**

n+1个控制点（0 ~ n ）可以得出n阶贝赛尔曲线

<img src="https://pic2.zhimg.com/80/v2-a83231e692e7fd7cdca5812dcc01cc27_720w.webp" alt="img" style="zoom:50%;" />

- 伯恩斯坦  多项式：

<img src="https://picx.zhimg.com/80/v2-9be3b25d2bce12b3771e2a3acb18933f_720w.webp" alt="img" style="zoom:50%;" />

竖着的（n i）相当于 C(n,i)



贝塞尔曲线——

##### 一般代数公式

已知**n+1**个控制点，我们可以得到一个**n**阶的贝塞尔曲线。

这个曲线在任意时间t，都是已知点的线性组合，系数就是一个关于时间的多项式（二项分布/伯恩斯坦多项式）。

<img src="https://i-blog.csdnimg.cn/direct/43d81d98b62845df80df000366a81aa7.png" alt="img" style="zoom:50%;" />

举个例子

如果是在三维空间中绘制贝塞尔曲线，那么就输入三维空间内的坐标点即可：

<img src="https://i-blog.csdnimg.cn/direct/9ea440a9a7c245888ba3fbf7ecac629a.png" alt="img" style="zoom: 67%;" />

<img src="https://i-blog.csdnimg.cn/direct/ba1aafc6885a40d0b918b7d2dc9203f0.png" alt="img" style="zoom:50%;" />

这里为什么任何一个横坐标上的值的和都为1？

答案：<img src="https://i-blog.csdnimg.cn/direct/9aa58d6ef2b44fa2a6ba4f0e0ed49f3d.png" alt="img" style="zoom:50%;" />

这个式子的系数就是**（1 - t + t）**的**平方**的展开，即1本身的展开

即，任何T时刻的伯恩斯坦  多项式系数的和就是1.（竖着画一条红色线）

还有，上图是一个对称图形，可以理解为组合数学中的C（n,i）=C(n,n-i)。

>B03(t) 和 B33(t) 对称， B13(t) 和 B23(t) 对称，即**第 i 个和倒数第 i 个是对称的**。
>
>证明：
>
>Bin(1−t)=Cni(1−t)i(1−(1−t))n−i=Cni(t)n−i(1−t)i
>
>Bn−in(t)=Cnn−itn−i(1−t)n−(n−i)=Cnn−i(t)n−i(1−t)i
>
>两者相等。
>
>> 我的理解：只有满足t=0.5 或者满足上述条件时猜左才等于右  ，所以图像是对称的
>
>参考[伯恩斯坦多项式(Bernstein Polynomials)-CSDN博客](https://blog.csdn.net/TYILY/article/details/116455436)

* 4-贝塞尔曲线的性质

![img](https://i-blog.csdnimg.cn/direct/1600104217894e978444d4c7944d2df5.png)

（1）曲线一定过起点和终点

（2）起始点和结束点的切线的系数都可以计算出来，如果是四个控制点的话，切线的系数为3。（n=3的导数，然后把t=0代入倒数）

（3）仿射变换前后的几个控制点，所形成的贝塞尔曲线一致。这条性质仅限定为放射变换，投影变换并不满足这个性质

>### 常见的仿射变换包括：
>
>1. **平移（Translation）**：在x、y（和z）方向上移动一定的距离。
>2. **旋转（Rotation）**：围绕某一点或某条轴旋转一定的角度。
>3. **缩放（Scaling）**：在x、y（和z）方向上按比例放大或缩小。
>4. **剪切（Shearing）**：在某一方向上按照另一方向的比例进行伸缩

（4）贝塞尔曲线上任何一点在控制点形成的凸包内。

>##### （4）贝塞尔曲线在控制点形成的凸包内。
>
>凸包长这样：
>
><img src="https://i-blog.csdnimg.cn/direct/4e31e09c603945a8aa9afee3a34b8737.png" alt="img" style="zoom:50%;" />
>
>Q&A 
>
>如果控制点都是在一条直线上，那么画出来的贝塞尔曲线是什么样的？
>
>答：是这条线自己。因为它不能超过凸包的范围。



#### 2 逐段贝塞尔曲线（Piecewise Bézier Curves）

<img src="https://i-blog.csdnimg.cn/direct/e97df2b1716d4221bcf31a95704059ec.png" alt="img" style="zoom: 80%;" />

* 当控制点很多的时候，曲线的变化表现不够直观 → 于是人们一般将每4个控制点定义一段贝塞尔曲线，最后再将每段连起来
* <img src="https://i-blog.csdnimg.cn/direct/8619e2c5c7c248cea9f8ec4942500db1.png" alt="img" style="zoom: 80%;" />

那么如何保证衔接的地方光滑？

前者切线和后者切线，**方向相同、大小相同**。即，**衔接点处导数连续**。



##### 不同程度的连续性

![img](https://i-blog.csdnimg.cn/direct/c6d88b55e79e4130ac44478aa2cf803d.png)

（1）C0连续：两个点相等即可   （0阶导== 原函数）


![img](https://i-blog.csdnimg.cn/direct/caf054c2061c4d2cb0dd968de8fac180.png)

（2）C1连续：点相等，切线一致，一阶导连续

![img](https://i-blog.csdnimg.cn/direct/d689fb3028214b3b81703cf2b7325f76.png)

（3）C2连续：二阶导数连续



#### 3 其他样条曲线

![img](https://i-blog.csdnimg.cn/direct/6018144207074c7280e547856000dbd8.png)

- 对曲线的总结：一条连续的曲线，是由多个控制点控制的，任意地方满足一定的连续性

- 样条：可控的曲线

- B—Splines（[奇函数](https://zhida.zhihu.com/search?content_id=177094240&content_type=Article&match_order=1&q=奇函数&zhida_source=entity)样条）(复杂)

- - **对贝塞尔曲线的扩展**，在贝塞尔曲线上，比如控制点为10的时候，动一个点，每个地方都会发生变化（牵一发而动全身），有时候不需要这种情况，而是**需要我改变一个点，至多影响某个范围内的线（而不是全部），**用逐段贝塞尔也可以实现，但是人们希望更容易控制的，不需要分段，就出现了B-Splines

其中，NURBS是B样条的延伸。



### 曲面（Surfaces）

#### 2.1 贝塞尔曲面（Bézier Surfaces）

**1.每块连续的拼起来**

> 直观理解：4*4个控制点把一个平面拉上去
>
> <img src="https://i-blog.csdnimg.cn/direct/bbd3a52d9e684b8e87a75cc2b26236c8.png" alt="img" style="zoom:50%;" />
>
> 在两个方向上分别利用贝塞尔曲线
>
> 这里有一个动画演示，我文字描述一下：
>
> 1.先用横向每一行的控制点生成4条贝塞尔曲线（灰色线）
>
> 2.然后在纵向上，在不同时刻t，在上述4条贝塞尔曲线上取t时刻的值，然后得到四个点，再通过这四个控制点绘制贝塞尔曲线。（蓝色线）
>
> * 类似于先画经度，再画纬度

<img src="https://pic2.zhimg.com/80/v2-1f9f06a01e6b9c55eed55f8c8f340ef7_720w.webp" alt="img" style="zoom:50%;" />

**2.时间u上：四条贝塞尔曲线在u上的4个点 看成是另一条贝塞尔曲线（蓝色）的控制点**

**3.时间v上：计算出蓝色贝塞尔曲线上的正确的控制点，蓝色贝塞尔曲线水平、垂直方向扫过去(遍历u,v)，就形成了一个贝塞尔曲面**

**![img](https://pica.zhimg.com/80/v2-2037acea90e26d421b13fafc8f0d60e4_720w.webp)**



![img](https://pic2.zhimg.com/80/v2-9f33cceb0a8d1363730e86d35ed2117b_720w.webp)

**贝塞尔曲面是显式表示，因为是通过参数去映射的**



### 网格（Mesh） 下一讲

网格操作：几何处理（Mesh Operations: Geometry Processing）

> 网格是表示空间中的面的几何形状的最普遍的方法

- 网格细分（Mesh Subdivision）
- 网格简化（Mesh simplification）
- 网格正规化（Mesh regulation）：作用：不至于出现特别尖的三角形

![img](https://pic4.zhimg.com/80/v2-40e8f2f2ddfe0f53e3a9fac3488b6853_720w.webp)





## 12 几何（网格处理）、阴影图

### 网格处理

#### 一、[曲面](https://zhida.zhihu.com/search?content_id=177094743&content_type=Article&match_order=1&q=曲面&zhida_source=entity)细分

引入更多三角形

**细分的两个操作：分出更多三角形，让三角形的位置发生变化（因此原基础上拆分更多三角形并不能改变三角形的位置）**

##### ①Loop Subdivision（不是循环细分，是姓命名）—— 先细分，再调整

1.连每条边的中点分出三角形

<img src="https://picx.zhimg.com/80/v2-b1d1bcef630b31dff954329ec581b9ef_720w.webp" alt="img" style="zoom:50%;" />

2.调整旧，新的顶点来改变三角形位置，使其变得更加光滑

<img src="https://pica.zhimg.com/80/v2-84c07f7d3048a0cb508e7380445ca024_720w.webp" alt="img" style="zoom:50%;" />

##### 如何调整位置？（关键）

- 如何更新新的顶点的位置？

- - **新的顶点**：边的中点

  - - 新的顶点一定在一条边上，只要不是边界，一定会被两个三角形共享。共享边的两个顶点A、B，不共享的其余两点C、D

<img src="https://pic4.zhimg.com/80/v2-a8cf85f5477faf65a318bc8e80fc5e65_720w.webp" alt="img" style="zoom:50%;" />

- - - 公式是一种加权平均，这里讨论怎么用

- - **旧的顶点**如何做位置更新？

<img src="https://pic3.zhimg.com/80/v2-01d8f4f6ba33e1f491c650976a80ad84_720w.webp" alt="img" style="zoom:50%;" />



- - - 中间白点一部分使用周围点（neighbor）的[位置平均值](https://zhida.zhihu.com/search?content_id=177094743&content_type=Article&match_order=1&q=位置平均值&zhida_source=entity)，一部分自己的顶点位置（original）的平均值（两者加权）

      > n：顶点的度（与几个边相连）
      >
      > u：仅仅是与度相关的一个数

    - - eg：如果白点连了20个点，它可以相信周围的点；如果只连了两个点，那就相信自己更多

<img src="https://pic2.zhimg.com/80/v2-c790246bcc1625dd35c0926d5021166b_720w.webp" alt="img" style="zoom:50%;" />

可以看出，每个点位置稍微变化了

##### ②Catmull-Clark Subdivision (General Mesh) 为例

- 假设全为三角形网格，才能Loop细分来做；假设有四边形，Catmull能把这种情况分得比较好
- quad face：四边形面
- Extraordinary：奇异点（度为4的点）

<img src="https://picx.zhimg.com/80/v2-be424baf3456224bdff287fae1ed5719_720w.webp" alt="img" style="zoom:50%;" />

**做法：**

1. **取每条边的中点**
2. **取每个面的中点**
3. **中点之间连起来**

<img src="https://pic1.zhimg.com/80/v2-b7b87468856c32e3b4bbee82dca7756e_720w.webp" alt="img" style="zoom:50%;" />

一次细分→

<img src="https://pic4.zhimg.com/80/v2-c59f890a8dff0281c4ffd8905871528b_720w.webp" alt="img" style="zoom:50%;" />


（经过一二三的做法，一个正方形分成了四个；1,2为每条边的中点，3为三角形面的中点，连起来）

二次细分→

<img src="https://picx.zhimg.com/80/v2-f232560b16678caad2b1d3885ac23a47_720w.webp" alt="img" style="zoom:50%;" />

<img src="https://pic2.zhimg.com/80/v2-83da2f5040eee9a7cb781fb2aa83aca5_720w.webp" alt="img" style="zoom:67%;" />

1. 一次细分后，引入了两个新的奇异点
2. 新的奇异点的度是3（只要点处于非四边形面中，它一定是奇异点）
3. 经过一次细分后，所有的非四边形面都消失了

**性质：在细分之前，细分区域存在多少个非四边形面数，在细分之后就会变成多少个奇异点，并且一次细分之后所有非四边形面都消失了，也就是说奇异点数不会再增加**



###### 如何更新每个点？（了解）

**该细分方法考虑得更细：边上的中点，面的中点，旧的点（三者加权平均）**

<img src="https://pic1.zhimg.com/80/v2-74882091b11a14bfd156354dc59222b4_720w.webp" alt="img" style="zoom:50%;" />

Loop细分只能用于三角形面细分，Catmull细分可用于四边形面



#### 二、曲面简化

<img src="https://picx.zhimg.com/80/v2-0dbc87565bada6d3338fe083760e9237_720w.webp" alt="img" style="zoom:50%;" />

（类似思想：MipMap，LOD）

> LOD是Level of Detail的缩写，指的是在三维图形渲染中，根据物体与观察点的距离，自动调整物体的复杂度，从而在保证渲染效率的同时，也能够在视觉上保持合理的细节。LOD技术允许一个物体有多个预定义的模型，这些模型具有不同的细节层次，当物体离观察者较远时，使用细节较少的模型，当物体离观察者较近时，使用细节较多的模型

##### 做法：

**其中一种方法：边塌缩edge collapse**

![img](https://pic3.zhimg.com/80/v2-cf8a1f4344419e6ca556ae8d0f231b80_720w.webp)



- （如何判断哪些边是重要的，我要踏缩哪些点呢）

- - 方法：**二次误差度量（二次：平方）**

  - - （某个点放在某个位置上可以使最小化二次误差）
    - 优化这个点的位置，使得这个点到原来几个面的**距离平方和**最小

- 从**二次度量误差最小的边开始塌缩**，以此类推

- - 如何去选边？→ 给每条边打分（二次度量误差值）
  - 但是踏缩了一条边后，会影响其他边的二次度量误差



##### 核心算法：

（典型贪心算法，并没有考虑全局最优解，但是认为效果不错）

- 数据结构：优先队列/堆
- 先找二次度量误差最小值的边，做塌缩后，**动态更新**剩下边的二次度量误差值，再取最小的





## 13 光线追踪（基本原理）

### 引入

> 光栅化的着色是一种局部的现象，在其着色的过程中只会考虑着色点自己的信息，而不会考虑其他物体，甚至不会考虑物资自身的其他部分对着色点的影响。事实上这些都是会有遮挡的关系的，是会产生阴影的，为了解决这个问题，就有了光线追踪

#### Shadow Mapping 阴影贴图

**核心思想：如果一个点不在阴影里，那么这个点可以被摄像机和光源都看到**

局限：硬阴影，走样，只能处理点光源

具体实现细节：

① 先从光源看向场景，做一遍光栅化，不进行着色，只记录深度

② 再从摄像机看向场景，再做一遍光栅化，记录深度

③ 比较两次深度值，如果不相等，则说明该点在阴影中

**问题1**：渲染出来的阴影比较脏

**原因**：深度值的比较位浮点数比较，而判断浮点数相等势必会产生误差，虽然处理精度的方法有很多种，但并不能从本质上解决问题

**问题2**：走样

**原因**：本身储存的深度图存在分辨率限制，与渲染时的分辨率搭配不好的话，就会产生走样

![下载 (1)](.\CG入门img\下载 (1).png)

> 虽然shadow mapping 还存在一些问题，比如只能做hard shadow，要渲染两次场景，但依然被工业界广泛应用



Hard shadows vs. soft shadows

阴影的产生我们理解为 **点是否能被光源看到，而不是物体投影出阴影**

<img src="https://pic1.zhimg.com/80/v2-bcfa01c0b9fb3dd468bfca4345dee0e6_720w.webp" alt="img" style="zoom:50%;" />

软阴影是本影、半影、影子之外的一个过渡，它与光源大小有关，同时也说明点光源本身是不可能产生软阴影的

**阴影程度：取决于能看到多少光源**



光栅化局限：没有很好表示全局效果，做阴影效果不好，Glossy的反射，间接光照（光线多次弹射） - 麻烦，低效，不能保证正确性

### 光线定义

- 光线沿着直线传播
- 光线之间不会发生碰撞（不会交叉）（假设）
- **光线从光源发出来，最后到达眼睛**

光线追踪利用了一个性质 —— **光路的可逆性**

光线追踪的思路：光线从眼睛或者摄像机出发，在世界中不断弹来弹去，最后将那些点再与光源相连



### Ray Casting 光线投射

做的事情：怎样去生成不同的光线

- Generating Eye Rays

- - 提前假设：

  - - 认为人的眼睛是针孔摄像机，光源假设为点光源
    - 光线打到场景物体会发生完美的反射/折射方式

  - ①Eye Ray：从眼睛开始，往成像屏幕的任何一个像素投射，打到场景中某个位置（最近的交点，因为人眼肯定是看到最近的东西，从而也解决了深度测试的问题）

  - ②Shadow Ray：再从这个交点往光源连一条线，如果这条线上没有任何东西阻挡，那我们就认为该点被光线照亮；如果有，就认为该点在阴影中

（从眼睛开始，每个像素投射一根光线，和场景相交，找到最近交点，和光源连线，判定是否在阴影中，再计算着色（Blinn-Phone），写回像素的值）

<img src="https://picx.zhimg.com/80/v2-edcc8f505807d08f89b93d2b1818248d_720w.webp" alt="img" style="zoom:50%;" />

光线每个弹射的点，都可以去计算着色值 —— 点都与光源连线；光源把每个弹射的点的着色，最后加入到最开始那个点的像素值里面（光线弹射有能量损失）



光线类型：

- Camera Ray / Eye Ray：从摄像机/眼睛打出来的第一根光线（Primary ray）
- secondary ray：再次弹射的光线
- shadow ray：为了判定点的可见性，点与光源所连的线



### 技术问题

#### ①Ray-Surface Intersection 求光线与表面的交点

- 数学上的光线有一个起点，有方向，就是一条射线，于是得出光线方程

<img src="https://picx.zhimg.com/80/v2-ddbdcaf43e65d169e556fd0301818d19_720w.webp" alt="img" style="zoom:50%;" />

- - - 射线只有一个方向（图形学很少去考虑边界值）

<img src="https://pica.zhimg.com/80/v2-290f514f8611a011399558f3fda2916a_720w.webp" alt="img" style="zoom:50%;" />



**<img src="https://pic4.zhimg.com/80/v2-a7fc3becec1312c690543801dc05e929_720w.webp" alt="img" style="zoom:50%;" />**

- - - 求交：该点同时满足光线和球的方程
    - 解函数，三种情况：相离，相切，相交（取距离最近的点）

**推广到隐式表面的求交**

↓

<img src="https://pic1.zhimg.com/80/v2-5afd903a097898890001855ff5d5d8e2_720w.webp" alt="img" style="zoom:50%;" />

- - **点（p = o + td）要有意义：**
    - **必须是实数，**
    - **方向是正的 （t>=0）**

- **显式表面求交**（**求光线与三角形的交点**）

- - 可以判断是否在物体内：一个点在封闭图形内，在任意方向打一束光线出去

  - - →奇数个交点：在封闭图形内（只有出）
    - →偶数个交点：在封闭图形外（有进有出）
    - 推广到3D仍然适用

  - 前提

  - - 每个三角形都计算会非常慢（4k,几十万面数）

<img src="https://pic2.zhimg.com/80/v2-ebdc2f18191ed77001595bd4322798b5_720w.webp" alt="img" style="zoom:50%;" />



- - **做法分解为：**

  - - **求光线与平面的交点**
    - **判断交点是否在三角形内部**

定义一个平面：**一条法线、一个点**

- 法线与平面上任意一条线段垂直

- - 定义点P的要求：任何一个在平面上的点P与给定点P'的连线都与N法线垂直

<img src="https://picx.zhimg.com/80/v2-7503c770869856c17cfc0f32129b4e51_720w.webp" alt="img" style="zoom:50%;" />

平面方程

<img src="https://pica.zhimg.com/80/v2-554ecb1d4ea26bdabe7940875c52b9e4_720w.webp" alt="img" style="zoom:50%;" />



**Möller-Trumbore(MT)算法**（重心坐标）

- 一步解出光线与三角形的交点算法

<img src="https://picx.zhimg.com/80/v2-70a850dd0bdc8ede45bb0762455b776d_720w.webp" alt="img" style="zoom: 67%;" />

（左边式子：光线方程；右边式子：用重心坐标表示的三角形内的任意一点）

求解：t，b1，b2。三个未知量，三个式子 ——克莱姆法则

要求：t是正数，1-b1 - b2非负，b1，b2非负

<img src="https://pic2.zhimg.com/80/v2-8ff7328bd96b05296c08b738cd41471f_720w.webp" alt="img" style="zoom:50%;" />



#### ②光线与表面求交的加速算法

不可能光线与每个三角形求交一次，怎样加速的重要概念：包围盒（Bounding Volumes）

**思路：**

- 包围盒：一个复杂的物体可以用简单的形状包围起来，保证这个物体一定在这个简单的形状中。

<img src="https://pica.zhimg.com/80/v2-cc274c102e86562903c96f72ec3b72a4_720w.webp" alt="img" style="zoom:50%;" />

- **一个重要逻辑：如果光线连包围盒都碰不到，就更不可能碰到包围盒里的物体。**

3D中，长方体的理解：上下、左右、前后三个对面形成的交集

<img src="https://pic2.zhimg.com/80/v2-f4156219d095c81b533f923d149232f3_720w.webp" alt="img" style="zoom:50%;" />

<img src="https://pic2.zhimg.com/80/v2-1f3b74ce3f40db2623399bdd29b459c1_720w.webp" alt="img" style="zoom:50%;" />

<img src="https://pic2.zhimg.com/80/v2-1e08919d4b098a19f4257f215e34e697_720w.webp" alt="img" style="zoom:50%;" />



##### 通常用的：Axis-Aligned Bounding Box (AABB) 轴对齐包围盒

- 沿着x,y,z轴的，对应到2D情况，长方形的边一定是横平竖直的。

先从二维情况考虑：

- 光线是否和AABB相交？
- 长方形两个对面的交集，求光线进、出的时间？
- 如何求进、出时间？

<img src="https://pic2.zhimg.com/80/v2-33299031fb251a0e0b86789d487df3f3_720w.webp" alt="img" style="zoom: 67%;" />

三维情况：

- **核心逻辑：光线都进入了三个对面，才算进入了包围盒；只要离开了任一的对面，就算离开了包围盒**
- 计算**三组x,y,z平面的tmin,tmax**
- **T enter：光线进入最晚对面的时间 — tmin的最大值，T exit:最早离开对面的时间 — tmax的最小值**
- 光线与包围盒有交点：**进入时间 < 离开时间（光线在包围盒里待了一段时间）**



**特殊情况：**

- 如果**离开时间 < 0**：包围盒在光线背后（点往后延伸的射线），不可能有交点
- 进入时间<0，离开时间>0：光线在盒子里，一定有交点

<img src="https://pic2.zhimg.com/80/v2-f6445f5295a6048343e7ea0adc0403ed_720w.webp" alt="img" style="zoom:50%;" />

（iff：当且仅当）

**结论：当且仅当，光线进入时间小于光线离开时间，并且离开时间大于等于0的时候，光线与包围盒有交点**



**为什么要平行于轴呢？Why Axis-Aligned**

<img src="https://pic3.zhimg.com/80/v2-a17b8a3f3b0fb613b5b9b815d8a76aa8_720w.webp" alt="img" style="zoom:50%;" />

因为可以简化计算，减少计算量





## 14 光线追踪（加速结构）

学东西：**why，what，**how to use

### today

* AABB 加速方法
  * KD树
  * BVH
* 辐射度量学 （没讲完）



### AABB求交的加速方法：

#### 1.均匀格子

- 进行光线追踪之前，先对场景进行预处理，对要处理的场景先找一个包围盒
- 把包围盒划分为一个个的均匀格子
- 标记与物体相交的格子（这里的相交指的是与**物体表面相交**）
- 根据光线的方向判断出所有相交的格子，如果格子里有物体表面，再进一步判断光线是否与物体相交

格子数量也是决定性能的关键，格子太稀疏，没有起到加速效果；格子太密集，判断与方格的求交可能会拖累效率

均匀格子不适用的情况：（场景中物体分布不均匀）场景中出现物体大规模集中，又有大规模的空白。



#### 2.空间划分

（基于均匀格子的不足所提出的 —— 在空白地方格子大点，在物体密集的地方格子小点）

##### 2.1 Oct-Tree（八叉树）

（八叉树在二维情况下是四叉树）

划分方法：

- 先把场景用一个包围盒包住
- 再将包围盒划分为八块（三刀 - 上下，前后，左右）
- 对每一块（子节点）再划分成四块
- 停止的条件：直到发现某一块里面没有物体了，那块就没必要继续划分下去；或者是某一块里的物体数量足够少，就可以停下来了。

缺点：

- 八叉树与维度有关，随着维度的上升划分的空间数量会呈指数级增长。

- - eg：二维下是四叉树，三维是八叉树，2的次方增长

（因此，有了KD-Tree这种方法）



##### 2.2 KD-Tree

划分方法：

- 将包围盒划分成两部分

- 之后每次划分只沿着一个轴划分（比如第一次是沿x轴划分为上下两部分，那第二次就沿着y轴划分为左右两部分，第三次沿着x轴……以此类推）

- - （三维就是沿着x,y,z）
  - 只规定了方向，没有规定一定划在正中间

- 存储：中间节点只存储指针指向两个子空间，只在叶子节点存储对应空间的所有物体或者三角面信息

![img](https://pica.zhimg.com/80/v2-0e681f1814c9e16230805f3954135d9a_720w.webp)

（每一块都要这样分，只是用一块举例子）

划分完KD-Tree后，如何去判断光线是否与物体有交点：

![img](https://pica.zhimg.com/80/v2-549cf0ee682334a25f77e55d409e038c_720w.webp)

1.假设一根光线与包围盒A进行相交测试

2.光线与1有交点，因此要判断光线与1里面的所有物体是否相交

3.光线与右边的B区域有交点

4.判断光线与2是否有交点 → 有交点，于是要判断光线与2区域里面的物体相交情况

（以此类推，因为与5区域没有交点，于是不用进一步判断）



优点：倘若光线与某一部分的空间不相交，那么这部分空间的所有子空间的物体与光线都不相交

缺点：

* **判断包围盒与三角形面相交有困难，**
* 有可能会出现三角形同时存在于两个包围盒的情况（如上图）



##### 2.3 BSP - Tree

- 划分方法与KD-Tree一致，唯一不同的是划分不沿着固定一轴，可沿着任意方向划分

缺点：

- 划分方向不规则，求交不好计算，维度越高会越来越复杂

<img src="https://pica.zhimg.com/80/v2-2291209f80411edc1bcef56ce7e05dca_720w.webp" alt="img" style="zoom:50%;" />



#### 3. 按物体划分

BVH

BVH是"Bounding Volume Hierarchy"的缩写，中文翻译为“层次包围盒”

（基于KD-Tree的缺点，不通过空间划分，而是通过物体来划分）

划分方法：

1.将一个包围盒里的物体划分为两部分

![img](https://pic2.zhimg.com/80/v2-97add64571a7ede6d5e306d388062e3f_720w.webp)

2.蓝色部分再去进行划分 —— （递归：将每部分都拆分成两个部分，并且重新计算每个部分的包围盒）

![img](https://pic3.zhimg.com/80/v2-c89ca053994d6237ec08bf1b7a879b68_720w.webp)

- **（停止条件：划分到某个节点里的三角形数小于等于一个设定的值，就停止划分）**
- BVH特点：包围盒之间可能重叠，但一个物体只可能出现在一个包围盒里
- 引发的问题：空间划分不严格，包围盒之间会相交
- 存储：与KD-Tree一样



##### **怎么划分BVH呢？**（很多种方法）

<img src="https://pic3.zhimg.com/80/v2-0100dc33bdde67912e6827951dd7264a_720w.webp" alt="img" style="zoom:50%;" />

- BVH也可以像KD-Tree那样选择一个维度：**依次**沿x,y,z轴这样划分，保证空间均匀

<img src="https://pic4.zhimg.com/80/v2-a65d539a4e2fd796c2b398b0b232f487_720w.webp" alt="img" style="zoom:50%;" />

- 技巧：**为了让空间均匀分布：只沿着最长的轴进行划分**

- 一个节点里知道该沿哪个轴去划分后，**如何把这个空间的三角形数分成两半呢**？

- - 找中间的三角形（找第二分之n个三角形 - 中位数）

（这样能**保证划分为两部分的三角形数量差不多**，使得树形结构更加平衡，意味着树的深度变小，从而使得平均搜索次数变少）

- - 如何找中间的三角形？

  - - 涉及到排序问题
    - 已知**要沿某个轴进行划分，找所有三角形的重心**。（比如说x轴，就找重心坐标的x轴的中位数）

（在一堆无序数里，可以通过快速选择算法，受**快速排序**的启发，可以在O(n)时间找到中位数）

- 快速排序算法：在这堆无序数中，以一个数为基准，比该数小的移动到数的左边，比该数大的移动到数的右边。实际上我们需要找到中间的某个位置 k，这样 k 左边的值全部比 k 上的值小，k 右边的值全部比 k 上的值大。

##### **BVH与光线的求交算法：（与KD-Tree类似）**

![img](https://pica.zhimg.com/80/v2-2e922badf62850fcb03439338280e89c_720w.webp)

##### **总结：**

KD-Tree对空间划分，BVH对物体划分





## 15 光线追踪（辐射度量学、渲染方程与全局光照）

### today

* 继续辐射度量学
* 复杂的光线传播理论
  * 反射方程
  * 渲染方程
* 全局光照
* 简单概率论



### 一、Basic Radiometry（辐射度量学）

（在前面的whited-style光线追踪模型，没有对漫反射的光线进行追踪，而是直接返回当前着色点的颜色。计算光源的直接照射贡献时，采用的是Blinn-Phon模型，这个模型本身就是不准确的经验模型，因此whited-style光线追踪本身也不算正确的）

- 辐射度量学精确定义实际光一系列的物理量，精确描述光如何与表面作用
- 辐射度量学：定义了一系列方法和单位去描述光照的属性

#### 概念：

##### ①Radient Energy（单位：焦耳）

- 光线辐射出来的能量

![img](https://pica.zhimg.com/80/v2-6dc2e9e14d1648f3a261c2609c5e5c8a_720w.webp)

##### ②Radient Flux (Flux与Power功率一样) （单位：瓦特）

> 辐射通量

- 单位时间的能量（类比物理中的功率 / 单位时间光通量）
- 光学中的功率有另一个单位：流明
- 在生活中，人们一般关注单位时间的效果，比如60W的灯泡和80W的灯泡亮度

![img](https://picx.zhimg.com/80/v2-5fc13073dd0cea9a3cae71f717221989_720w.webp)

> W 和 lm 是两个完全不同的单位，可以互相换算

（图形学中基本说得能量：energy，power，flux都是指单位时间的能量，不是实际能量）

##### ③Radient Intensity （单位：candela,cd）

> 辐射强度

- the power per unit solid angle(立体角)
- 每个单位立体角上的power（功率/立体角）
- 每个单位立体角上，光源在单位时间发射的能量（即不同方向上，光源辐射出来的Power）

<img src="https://pic3.zhimg.com/80/v2-8ca25f8e0c19767edc737f4779d9441e_720w.webp" alt="img" style="zoom:50%;" />



**立体角：（单位：steradians，sr）**

- 角度的定义 -  弧度制：弧长/半径

- 一个圆对应的弧度：2π

- 立体角就是角度在三维空间中的延伸，一个球会投影到球面上，有一个面积（面积/半径的平方）

  - 说白了就是空间中的角有多大

- 一整个球的立体角是4π

<img src="https://picx.zhimg.com/80/v2-275df329fffca8230493e155d052ce4f_720w.webp" alt="img" style="zoom:50%;" />

**单位立体角的计算方法：**

**（（以物体为球心，投影到单位球上的球面面积）/ r^2）**

- 通过（θ，φ）来确定方向，θ：面离z轴距离的角度，φ：面绕z轴旋转的角度
- 因为是矩形，所以算出来两条边的长度，再求面积
  <img src="https://picx.zhimg.com/80/v2-148740130826b65ffb683c536ce0d343_720w.webp" alt="img" style="zoom: 67%;" />

可以看成是两个球面分别求弧长 近似边长

> 雅可比行列式换为球面坐标
>
> ![img](https://i-blog.csdnimg.cn/blog_migrate/06c07704e66c0265d6bdac52b1913030.jpeg)
> 结合这张图应该能看懂
>
> 其中 rdθ 就是微分面积元的高
> rsinθdϕ 就是微分面积元的宽。



<img src="https://pica.zhimg.com/80/v2-10daf30ee5fc29049bd186d6d1cae118_720w.webp" alt="img" style="zoom: 67%;" />

（整个球的立体角：4π）

- 记住结论：单位立体角是sinθdθdφ（微分立体角/ 极小的立体角）

- > 微分立体角与sinθ（实际θ位置有关）

<img src="https://pic3.zhimg.com/80/v2-ede3399cb10a2e5bd665087772b67fd0_720w.webp" alt="img" style="zoom: 67%;" />

**上图想表达的意思是：**

- **点光源从一个方向上看，它的power/该方向的立体角 = 该方向的Intensity，也就是说所有方向的Intensity积分起来，可以得出该光的power**
- **假设一个点光源是往各个方向上均匀辐射出能量，那么任何一个方向上的Intensity 就是φ/4π**

> **举例：**
>
> <img src="https://pic1.zhimg.com/80/v2-4cce9dd49ec3f39971dc2be97e20ffd2_720w.webp" alt="img" style="zoom: 67%;" />
>
> - （该灯泡实际上耗能11W，但是能发出相当于白炽灯60W的光）
> - 815lumens就是Flux
> - 灯泡的Intensity = φ / 4π = 815 / 4π ≈ 65candelas



##### ④Irradiance（辐照度）（单位：[lux](https://zhida.zhihu.com/search?content_id=179701059&content_type=Article&match_order=5&q=lux&zhida_source=entity)）

- Intensity：每个立体角上对应的能量
- **Irradiance：单位面积上接收到的能量**（面上的光能量必须是垂直的才能够接收到，因此如果光线不是垂直照射到面上，需要乘cosθ）

![img](https://picx.zhimg.com/80/v2-3c13c3fb53bf29ff4863b210a4d2ce85_720w.webp)

- 解释Blinn-Phong模型所提到的光线越远会越加衰减：

- - [球表面积](https://zhida.zhihu.com/search?content_id=179701059&content_type=Article&match_order=1&q=球表面积&zhida_source=entity)：4πr2 假设r= 1
  - 对比两个位置，可以发现是按r2 衰减，因此是Intensity没有变，是Irradiance在衰减

<img src="https://pic2.zhimg.com/80/v2-0a40f0d8c42868ea53187b7c19ca6a8f_720w.webp" alt="img" style="zoom:50%;" />

##### ⑤Radiance

- **非常重要的概念，和光线联系**
- 做两次微分：单位立体角，单位投影面积
  ![img](https://pic1.zhimg.com/80/v2-dd5cecdd130d519648d02f758a54a2d4_720w.webp)

定义：

- **Incident Radience：某个方向的能量打到一个dA面上，被dA吸收的能量多少就是radiance**
- **Exiting Radiance：（Intensity是每个立体角上的能量）dA中一个小面往某个方向（dw）辐射出多少Intensity**

![img](https://pic2.zhimg.com/80/v2-0eac978b47567274ef15d7b8512bda4b_720w.webp)

![img](https://pic3.zhimg.com/80/v2-956bb8779b6caf83849e4aa0babac5ce_720w.webp)

![img](https://picx.zhimg.com/80/v2-8dca6ed730713c2f2a3ef944a036fcd1_720w.webp)

（Irradiance与Radiance的区别：**Radiance**在Irradiance上增加了方向性）

**通俗理解就是：Irradiance描述的是d(A)接收到的所有能量；Radiance描述的是d(A)接收到的来自某一个方向上的所有能量**

<img src="https://pic4.zhimg.com/80/v2-62fda37271b842bf33b25e4b99d9472b_720w.webp" alt="img" style="zoom:50%;" />

Intensity, Irradiance, Radiancce三者的关系：Intensity在单位立体角作积分，Irradiance是在单位面积做积分，Radiance则是对这两个部分都做了积分。



#### 概念汇总

图形学里基本不考虑实际能量，只看单位时间的能量

- Intensity：单位立体角上对应的能量
- **Irradiance：单位面积上接收到的能量**（面上的光能量必须是垂直的才能够接收到，因此如果光线不是垂直照射到面上，需要乘cosθ）

> 我的理解：斜着接下的能量数（直观上就是线的个数）占总能量数的比例

<img src=".\CG入门img\image-20241005170338055.png" alt="image-20241005170338055" style="zoom: 80%;" />

|      物理量       | 符号 |     中文翻译      |                           简单定义                           |   单位    | 公式              |
| :---------------: | :--: | :---------------: | :----------------------------------------------------------: | :-------: | :---------------- |
|  Radiant Energy   |  Q   |     辐射能量      |                       电磁波形式的能量                       | 焦耳（J） | \                 |
|   Radiant Flux    |  P   | 辐射功率/辐射通量 |                     单位时间内的辐射能量                     | 瓦特（w） | P=dQ/dt           |
| Radiant Intensity |  I   |     辐射强度      |               点源向某单位立体角发射的辐射功率               |   w/sr    | I=dP/dω           |
|    Irradiance     |  E   |   辐（射）照度    |                **受照面**单位面积上的辐射功率                |   w/m2    | E=dP/dA           |
|     Radiance      |  L   |   辐（射）亮度    | 单位投影面积（垂直于光线方向的面积）、单位立体角上的**辐射功率** |  w/m2sr   | L=d^2P/dωdAcos(θ) |

> 参考[GAMES101-现代计算机图形学入门-个人笔记（全） - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/434498517)



### 三、反射方程：

- BRDF告诉我们每个入射光最后反射出去的强度，因此求每个入射方向的Radiance * BRDF * cosθ，最后把所有入射光的贡献加起来，就可以得到该[入射点](https://zhida.zhihu.com/search?content_id=179701059&content_type=Article&match_order=1&q=入射点&zhida_source=entity)在所有可能的入射光下，最后反射到某个方向上的光。

- **定义：任何一个着色点在各种不同光照下，把该点所有方向的入射光的贡献加起来，计算对一个特定出射方向的贡献（也就是那个方向上的东西该长啥样）**

- - 入射光不止是光源，也有可能是别的物体反射出来的

<img src="https://pica.zhimg.com/80/v2-2d6c305c0309a4986e2709f1a64c1f7e_720w.webp" alt="img" style="zoom:67%;" />

![img](https://pic1.zhimg.com/80/v2-3209828e3d8578378b9319085e95a7d4_720w.webp)



### 四、渲染方程

渲染方程：自身发出的光 + 其他物体反射过来/其他光源照过来的

![img](https://pic3.zhimg.com/80/v2-48b62f03df11f876cc2e8febf40c6e42_720w.webp)

<img src="https://pic1.zhimg.com/80/v2-fb4b895e7cbb60cda2c413c9aa2334d4_720w.webp" alt="img" style="zoom:67%;" />

（一个点光源对一个点）

<img src="https://pica.zhimg.com/80/v2-254e23f6c77a73c5b5fbe682cfdb2c9c_720w.webp" alt="img" style="zoom:67%;" />

（多个点光源对一个点）

<img src="https://pic3.zhimg.com/80/v2-0c47e1310e0c795ac0075b8f8e2b2970_720w.webp" alt="img" style="zoom:67%;" />

（面光源就相当于一堆点光源的集合） so积分

<img src="https://pic2.zhimg.com/80/v2-cea7a3eecd3a0494d1d9561de1766829_720w.webp" alt="img" style="zoom: 67%;" />

（如果入射光是其他物体反射出来的，就把物体当成是面光源，对其所占立体角进行积分即可）

<img src="https://pica.zhimg.com/80/v2-ef81816372f987f890379e699581e0c4_720w.webp" alt="img" style="zoom: 67%;" />

> 这个图有点问题，应该是蓝色字对应蓝色
> <img src="https://pica.zhimg.com/80/v2-ef81816372f987f890379e699581e0c4_720w.webp" alt="img" style="zoom:50%;" />

<img src="https://pic1.zhimg.com/80/v2-715a24e4fa4147cd483c887849643ce6_720w.webp" alt="img" style="zoom:67%;" />

（不断简写，L是要计算的，E是物体本身发出来的能量，KL是别的物体反射到该物体上的，K是反射因子）



#### 计算过程：

<img src="https://pic4.zhimg.com/80/v2-f109e4839388ba27e779f4a84f0cd57b_720w.webp" alt="img" style="zoom:67%;" />

- 将式子展开成可以直观的知道光源辐射出来的能量，加上光源辐射出来的能量经过一次、二次……反射后，我们能看到什么

- - E：就是光源直接打到我们的眼睛，所看到的
  - KE：光源经过一次反射后所让我们看到的
  - K^2*E：光源经过两次反射



容易混淆：

> 弹射1次：光源打到物体，进入眼睛（直接光照）
>
> 弹射2次（**进入眼睛这次弹射不计数**）：光打到物体，再反射打到其他物体→进入眼睛（一次间接光照）

- **光线弹射0次** — 直接打到我们的眼睛里 —— 这就是我们看到的**光源**

- **光线弹射一次** — 光源打到物体上，然后再打到我们的眼睛 — **直接光照**

- **光线弹射两次及以上，就叫间接光照**

- - 光线弹射两次的例子：从眼睛的角度去看，光线打到镜子（1次），再打到通过镜子反射出来的物体（2次），也就是说**反射一次以上是间接光照**

**全局光照 =（光源自己 + 直接光照 +  间接光照）的集合**



- **光栅化能告诉我们光线弹射0次和1次的光照内容，后面的部分比较难做到**

- **光线弹射次数越多，全局光照效果趋近收敛**（比如8次和16次，场景中的光几乎没什么变化）—— 越逼近自然界真实效果，不会光线弹射次数越多，场景越来越亮

- - （该问题在路径追踪里解决）
  - 能量守恒是一方面



本节知道了全局光照是什么，下一节去解全局光照（渲染方程）



## 16 光线追踪（蒙特卡洛积分与路径追踪）

### today

* 复习
* 蒙特卡洛积分 integration
* 路径追踪

上一节是为了正确得到[渲染方程](https://zhida.zhihu.com/search?content_id=179701334&content_type=Article&match_order=1&q=渲染方程&zhida_source=entity)，这一节是为了正确的解出渲染方程

### 蒙特卡洛积分 

— 解一个定积分的值：

- 当积分的解析式很难表示出来，但是我们只需要最终的值，并不是解析式，就用[蒙特卡罗](https://zhida.zhihu.com/search?content_id=179701334&content_type=Article&match_order=1&q=蒙特卡罗&zhida_source=entity)积分方法
- a,b之间采样很多次，对应的x,y，长方形的面积平均起来
- 在积分域内，不断去采样，x轴对应的y值，最后y值加起来求平均

<img src="https://pic1.zhimg.com/80/v2-dbb6b0f0723b8b4811810ac9d55b6f3a_720w.webp" alt="img" style="zoom: 67%;" />

- 黎曼积分：假设a,b之间均匀分成100份，每一份取中间的x，找到对应的y，每一份都认为是微小的长方形，即将**曲线到x轴之间的面积约等于是各个微小长方形的和**。
- 蒙特卡洛积分：不同于[黎曼积分](https://zhida.zhihu.com/search?content_id=179701334&content_type=Article&match_order=2&q=黎曼积分&zhida_source=entity)（分为多个微小的部分），蒙特卡洛积分为：用一个随机的采样的方法。随意取一个点，对应的y值为高，a到b的长度为宽，（假设为长方形）的面积来近似等于曲线下的面积，ab之间**重复多次采样**，最后平均起来长方形的面积。



### 如何定义蒙特卡洛积分

概率论：（离散求和，连续求积分）

- **离散情况：**

<img src="https://picx.zhimg.com/80/v2-4014afdb6693ef839acd2816c240f82d_720w.webp" alt="img" style="zoom:67%;" />

- **连续情况下描述变量和分布：**

<img src="https://pic1.zhimg.com/80/v2-76258ec36d3db00ebcccdac87ac32640_720w.webp" alt="img" style="zoom:67%;" />

PDF（概率密度函数）：Probability Distribution Function：所有可能的取值，对应的概率，即整个概率密度函数下方围起来的面积等于1（即pdf积分起来 = 1）

- 蒙特卡洛积分近似为

<img src="https://pic1.zhimg.com/80/v2-503f063dd7c0f0cf398936872fd3de2a_720w.webp" alt="img" style="zoom:67%;" />

<img src="https://picx.zhimg.com/80/v2-9fc6ae978cd362fa329574459f28064b_720w.webp" alt="img" style="zoom:67%;" />

- - 假设a到b之间是均匀采样，那么采样用的pdf是常数，各处相同。又因为pdf积分出来是1，即可得出常数C的值。

- 因此蒙特卡洛积分的最终表达式：

<img src="https://pic1.zhimg.com/80/v2-61f337c801c1bf44a78ab57a128110ca_720w.webp" alt="img" style="zoom:67%;" />

- - N是采样次数

- 

### 路径追踪

- 解决Whitted-Style Ray Tracing 在处理光照反射时**不能很好表现类似于有光泽(glossy)但并非完全镜面的物体材质**
- **先考虑直接光照（忽略自发光项）— 半球在不同方向的积分：**

<img src="https://pic3.zhimg.com/80/v2-31d7332f5c09e7fc77a47bed12842464_720w.webp" alt="img" style="zoom:67%;" />

- - > 因为要使用蒙特卡罗积分，所以需要随机选择N个Wi方向

  - - 着色点p，出射方向o（算各方向的光对该点的直接贡献），以一个pdf值在半球上采样N个方向
    - 初始化Lo
    - 对任何一个选中的方向，从p点往这个方向去连出一条光线；如果光线打到了光源，就把这整个式子写出来（因为知道了Li，Radiance，知道[入射方向](https://zhida.zhihu.com/search?content_id=179701334&content_type=Article&match_order=1&q=入射方向&zhida_source=entity)，出射方向也就知道了BRDF）

- **考虑[间接光照](https://zhida.zhihu.com/search?content_id=179701334&content_type=Article&match_order=1&q=间接光照&zhida_source=entity)：（假设摄像机放在P点，观察Q的直接光照）**

<img src="https://picx.zhimg.com/80/v2-c6c3300a3be870668f5ec76ca4a7a60f_720w.webp" alt="img" style="zoom:67%;" />

<img src="https://pic1.zhimg.com/80/v2-b6b5f2e5dd37725bd74d8a54eda8a2be_720w.webp" alt="img" style="zoom:67%;" />

- - 如果光线打到的是物体，就算Q点反射过来的Radiance是多少，-wi是因为从p点往外走的方向是wi，那么从Q点来说就是-wi方向往p去
  - 这里相当于是把Q点直接光照的结果作为反射给P的光照



- **问题一：**

（然而，以这种方式来计算，光线数量会爆炸）

<img src="https://pic4.zhimg.com/80/v2-24c948a651ea7e81928c1d6c6dfb4d5f_720w.webp" alt="img" style="zoom:67%;" />

（一个点打出100根光线，然后这100根光线又分别打出100根光线，[指数爆炸](https://zhida.zhihu.com/search?content_id=179701334&content_type=Article&match_order=1&q=指数爆炸&zhida_source=entity)）

- - 如果N等于1，也就是每次只采样一个方向，那么N的多少次方都是1，但是这样得出的结果会非常noisy，噪声非常大。
  - N= 1的方法就是[路径追踪](https://zhida.zhihu.com/search?content_id=179701334&content_type=Article&match_order=2&q=路径追踪&zhida_source=entity)

- 解决：

![img](https://pica.zhimg.com/80/v2-17c61777e6da73eeea09f8742f5d428a_720w.webp)



- - 对某个像素重复多次采样，但是每次在反射的时候只随机选一个方向，解决了只对经过像素的光线采样一次，而对反射光线按分布采样多次所导致的光线爆炸问题。但是这样引发了一个问题，光线递归下去，没有停止的条件。

  - > 注意定义的方向始终朝外



- **问题二：**光线弹射永远不会停止（递归）

- 解决：

- - 如果是简单的规定弹射次数，会引起光线能量损失，因此引入了一个方法：[俄罗斯轮盘](https://zhida.zhihu.com/search?content_id=179701334&content_type=Article&match_order=1&q=俄罗斯轮盘&zhida_source=entity)赌
  - 用俄罗斯轮盘赌的方法来决定以一定的概率去停止光线继续往下追踪

<img src="https://pic2.zhimg.com/80/v2-17234edd81e77484238bd1d4d6e5e549_720w.webp" alt="img" style="zoom:67%;" />

（期望值没变）

- - 最终Path Tracing的方法：

<img src="https://picx.zhimg.com/80/v2-a7e23b2319c51f76a743ea94a241ea73_720w.webp" alt="img" style="zoom: 67%;" />

- - - （随机选一个概率P_RR，在[0,1]里随机取一个数ksi，如果ksi > P_RR，就认为该光线不存活下来；如果ksi<P_RR，就正常发射光线，最后返回的结果去除以P_RR）



- **上面的路径追踪方法效率非常低下，当光源很小的时候，有很少的光线能打到光源，那么会有大量采样的光线都被浪费了**

- - 改进：直接对光源上的采样。假设光源面积为A，那么pdf = 1/A，因为

![img](https://pic4.zhimg.com/80/v2-9dc7018282d47025892f8b4c0a4540ed_720w.webp)

- - 渲染方程是对立体角上的光线方向做积分，如果想要对光源进行采样并依然使用[蒙特卡洛方法](https://zhida.zhihu.com/search?content_id=179701334&content_type=Article&match_order=1&q=蒙特卡洛方法&zhida_source=entity)，需要将渲染方程改写成对光源的积分（**即找到dA与dw的关系**）

  - - 
    - 
    - 
    - 
    - 
    - 
    - 
    - 
    - 
    - **dw = dA / r2**

<img src="https://pic4.zhimg.com/80/v2-5f1769aa777cc6557845aa4853fd1811_720w.webp" alt="img" style="zoom:67%;" />

（dA垂直着色点的面积dAcosθ）

- - - 因此渲染方程改写如下：

![img](https://pic2.zhimg.com/80/v2-651d2a23aabc5b1d30d33957c5f0d717_720w.webp)

——对光源采样，对光源积分

- - 因此某点的着色的结果可以分成两部分来计算：

<img src="https://pic3.zhimg.com/80/v2-047382acffdc0e63232a781302158e50_720w.webp" alt="img" style="zoom:67%;" />

- - - 1、光源的贡献：通过对光源的采样来解（不需要俄罗斯轮盘赌）
    - 2、其他所有非光源的贡献，采取之前的方法来计算（需要俄罗斯轮盘赌）



![img](https://picx.zhimg.com/80/v2-fc3921dd66229deeb62802d4ea02e6d9_720w.webp)



PS：在什么领域，就在什么领域进行积分



- 以上的计算都是在光线中间没有物体遮挡的情况计算的贡献

- - 因此还需要在计算前先判断下着色点与光源直接是否有物体遮挡

  - - **方法：点P到点x'之间连线，判断是否与光源之外的物体相交即可**

<img src="https://pic4.zhimg.com/80/v2-4972a33fd9cae435e54c79cdc8a7c971_720w.webp" alt="img" style="zoom:67%;" />



### 其他

- 现代的Ray Tracing更多理解为所有光线传播方法大集合

- - 不单指Whitted-style ray tracing
  - 单向/双向Path Tracing、[光子映射](https://zhida.zhihu.com/search?content_id=179701334&content_type=Article&match_order=1&q=光子映射&zhida_source=entity)、VCM/UPBP等

- **问题：**

- - 怎么对半球均匀采样？

  - 选择什么样的pdf是最合适的？

  - 可以结合半球和光源采样吗？（MIS）

  - 为什么不同路径的radiance的平均值就是该像素的radiance，需不需要加权？（[重要性采样](https://zhida.zhihu.com/search?content_id=179701334&content_type=Article&match_order=1&q=重要性采样&zhida_source=entity)理论）

  - 像素的Radiance不是像素的颜色，他们之间不是线性对应的，中间需要经过Gamma矫正

  - - 还有些概念：HDR图，Curve，颜色空间等

![img](https://pica.zhimg.com/80/v2-1f007a3131de1d88f0c97972978e3320_720w.webp)

![img](https://picx.zhimg.com/80/v2-931c714a3ccb9370deb218be6f11f14b_720w.webp)





## 17 材质与外观

**Materials and Appearances**

**材质 = BRDF**

### today

* 围绕材质与外观

###   漫反射

- 任何方向的光进来都会被均匀的反射到周围各个不同的方向上去

![img](https://picx.zhimg.com/80/v2-352c1c317aac8f81ebdbea10819365f3_720w.webp)


假设能量守恒，那么Li = Lo，这时候BRDF就 = 1π ，就可以定义一个反照率（Albeo）— ρ，在（0,1）之间 。这样就可以引入不同颜色的BRDF，BRDF = ρπ ，BRDF在（0， 1π ）之间。

###   GLossy

![img](https://picx.zhimg.com/80/v2-24b4f2c65eebb8c582fd8d6f8eb1ebed_720w.webp)

###   玻璃/水

![img](https://pic1.zhimg.com/80/v2-95fc8864a5065b314e4816c3fc8fb07c_720w.webp)

###   反射方向的计算

![img](https://pica.zhimg.com/80/v2-081ea14e614a07d059a675456039ffb2_720w.webp)

[平行四边形法则](https://zhida.zhihu.com/search?content_id=182200067&content_type=Article&match_order=1&q=平行四边形法则&zhida_source=entity)： ωi + ωo 值沿着法线方向，n又相当于 ωi 投影到法线方向上的长度



###  折射（BTDF，Transmit）  Snell's Law[折射定律](https://zhida.zhihu.com/search?content_id=182200067&content_type=Article&match_order=1&q=折射定律&zhida_source=entity)

![img](https://pic1.zhimg.com/80/v2-f78e88bf3d0f6a6eb4e9f61e99ac036c_720w.webp)

（θi,θt这两个角满足和折射率相乘，结果相等的关系）



![img](https://pic2.zhimg.com/80/v2-f48443b02f4d2cb3d937755e7d988765_720w.webp)



- 求[余弦](https://zhida.zhihu.com/search?content_id=182200067&content_type=Article&match_order=1&q=余弦&zhida_source=entity)是为了算出一个有意义的实数，如果结果得不到一个有意义的实数，那么说明这个折射不可能发生。
- 什么时候有意义呢？ — 当根号里的值>0时 — 从式子可以看出，当η(i)>η(t)时，即入射光的折射率 > 反射光的折射率，不会反射反射。换句话来说，就是[全反射](https://zhida.zhihu.com/search?content_id=182200067&content_type=Article&match_order=1&q=全反射&zhida_source=entity)现象的条件。

**BRDF + BTDF（折射） = BSDF(散射，scatter)**



###  菲涅尔项

![img](https://picx.zhimg.com/80/v2-0e65f47c66dcd445deefa9c93b67839b_720w.webp)

（不同角度观察，反射的情况不一样）

- **绝缘体（Dielectric）**：如果**[入射光线](https://zhida.zhihu.com/search?content_id=182200067&content_type=Article&match_order=1&q=入射光线&zhida_source=entity)完全与物体处于平行状态（即x=90处）**，则认为其将光线完全反射；而入射光线与物体完全垂直（即x=0），则认为其光线只有少部分被反射，大部分被吸收了：

![img](https://pic2.zhimg.com/80/v2-1504ef2ec22ea4b009e0394401baf3f3_720w.webp)



- **导体（Conductor）：**

![img](https://pica.zhimg.com/80/v2-e7ce4c091a373e2e86bc9254036d104a_720w.webp)


**[菲涅尔](https://zhida.zhihu.com/search?content_id=182200067&content_type=Article&match_order=2&q=菲涅尔&zhida_source=entity)的计算：**

![img](https://pic3.zhimg.com/80/v2-fe0faa67a981178dbf78b41c3c88b0e2_720w.webp)



###   微表面材质

- 当距离足够远时，我们看向一个物体的时候，看不到它表面上微小的东西，我们能看到的是最终他们对表面形成的作用

![img](https://pica.zhimg.com/80/v2-41ce3461bae5ad00022693cbb356366a_720w.webp)

（比如高光位置，我们看不到高低起伏的山，坑坑洼洼）



![img](https://pic3.zhimg.com/80/v2-4f53f6ad017d8cdcbfb5ec1f19a709a0_720w.webp)

（bumpy：凹凸不平）
**总结：微[表面模型](https://zhida.zhihu.com/search?content_id=182200067&content_type=Article&match_order=1&q=表面模型&zhida_source=entity)，从远处看，看到的是材质外观；从近处看，看到的是几何**

每一个微表面都认为是一个**微小的镜面**，每个微表面都有自己的法线方向

![img](https://picx.zhimg.com/80/v2-bf5b29aff594b30b45f7a508e9917327_720w.webp)



- Glossy材质的微表面的法线方向与宏观上的法线方向差别不大
- 粗糙的材质，微表面的法线方向与宏观上的差别就很大，就会形成[漫反射](https://zhida.zhihu.com/search?content_id=182200067&content_type=Article&match_order=2&q=漫反射&zhida_source=entity)现象

**（用微表面法线方向分布情况来描述表面的粗糙程度，微表面法线方向集中是Glossy，……分散是漫反射 ）**



###  微表面的BRDF计算：

![img](https://pic1.zhimg.com/80/v2-7fc6f2f362c0a6ae0a5861dadf496c8a_720w.webp)

![img](https://pic1.zhimg.com/80/v2-bdafbed0a81903e6c5f3c5b8946d3ec0_720w.webp)

- **F：菲涅尔项**，描述反射程度（不同入射方向会有不同程度的反射，参考上面菲涅尔的[反射图](https://zhida.zhihu.com/search?content_id=182200067&content_type=Article&match_order=1&q=反射图&zhida_source=entity)）

- **G：几何项**，微表面是在物体表面上，有可能会发生被遮挡情况（如右图），就容易发生微表面自遮挡自投影现象

- - Grazing Angle（掠射角度）：入射光方向/观察方向接近Grazing Angle（方向与物体平行）
  - 为了修正菲涅尔计算的被遮挡的微表面的反射情况（被遮挡的微表面不发生反射）

- D：**法线的分布值**（给定一个方向，在这方向上法线的分布有多少），**h是half vector（[入射方向](https://zhida.zhihu.com/search?content_id=182200067&content_type=Article&match_order=2&q=入射方向&zhida_source=entity)与出射方向的中间值）**，只有当**微表面的法线方向和half vector的方向完全一致的时候，这样的微表面才能把入射光反射到出射方向上去。**（微表面都认为是镜子）

- - D决定什么样的微表面才能把入射光反射到出射方向上去

![img](https://pic3.zhimg.com/80/v2-ddb369ccc4d88498de4530a5f565c61e_720w.webp)

<img src="C:\Users\86138\AppData\Roaming\Typora\typora-user-images\image-20241008145733452.png" alt="image-20241008145733452" style="zoom:50%;" />



###   区分材质的一类方法： 


**各向同性（Isotropic）：**按照法线分布来看，各个方向上的法线分布均匀，没有一定的方向性；
**各向异性（Anisotropic）：**法线方向有明确的方向性。

![img](https://pica.zhimg.com/80/v2-1e8488f312a164dbde3301dfdeda225c_720w.webp)



- 判断：如果入射光线和出射光线满足按照[方位角](https://zhida.zhihu.com/search?content_id=182200067&content_type=Article&match_order=1&q=方位角&zhida_source=entity)进行一定旋转后其相对位置不改变的性质，那么该物体就是各向同性


[各向异性](https://zhida.zhihu.com/search?content_id=182200067&content_type=Article&match_order=2&q=各向异性&zhida_source=entity)例子：

![img](https://pic4.zhimg.com/80/v2-53f8a82fb973ea756e23754d216484fb_720w.webp)



###   BRDF性质： 

1. 非负性：BRDF的值永远是非负的，表示了一个能量的分布，能量不可能是负。

![img](https://pica.zhimg.com/80/v2-79cef557a086a1144d3b537c231b184a_720w.webp)

（negativity：n.负性）

1. 线性性质：可以各个模块分别拆出去进行各种计算，最终各个模块相加

![img](https://pica.zhimg.com/80/v2-98ab996a44c93bf42a614641c20891b2_720w.webp)



\2. 可逆性：交换入射光和出射光方向，严格意义上得到的BRDF值是一样的

![img](https://pic1.zhimg.com/80/v2-cac03e83603ce2ad0584c9c149d6ca92_720w.webp)

（reciprocity：n.相互作用）

\3. 能量守恒：[出射光](https://zhida.zhihu.com/search?content_id=182200067&content_type=Article&match_order=3&q=出射光&zhida_source=entity)不会大于入射光

![img](https://pica.zhimg.com/80/v2-7158ae5caa913654bcbfb84f0c9bd4ea_720w.webp)

- = 1的情况是入射光完全反射出去，没被吸收
- 回想之前path tracing里光线弹射后是收敛而不是光线爆炸，就是因为BRDF能量守恒的性质



\4. 各向同性，各向异性（考虑方位角的变化）

![img](https://picx.zhimg.com/80/v2-22f3b323447a222cfbddd1eeb4a1b113_720w.webp)

1. 1. 各向同性材质：可以将四维的计算降为三维。根据可逆性，可以得出[相对方位角](https://zhida.zhihu.com/search?content_id=182200067&content_type=Article&match_order=1&q=相对方位角&zhida_source=entity)的计算不用考虑正负（|φi - φr|）



###   BRDF的测量与存储：


**①测量：**
为什么要测量：

- 理论推导的BRDF不太准确，有些地方是简化计算，能测出来就不同自己再去推导模型


怎样去测量：

- 给定一个着色点
- 给定出射方向（固定相机位置），移动光源从四面八方照射着色点
- 给定入射方向，[移动相机](https://zhida.zhihu.com/search?content_id=182200067&content_type=Article&match_order=1&q=移动相机&zhida_source=entity)从四面八方去观测着色点


[伪代码](https://zhida.zhihu.com/search?content_id=182200067&content_type=Article&match_order=1&q=伪代码&zhida_source=entity)：

![img](https://pica.zhimg.com/80/v2-f14c6bd919fcc8f1783959eab7cd079e_720w.webp)


如果物体是各向同性，就可以将4维复杂的计算降为3维，再考虑可逆性，又可以降低计算量

**②存储：**

- 存储量非常大 → 各种**压缩**方法
- 有名的BRDF库：MERL BRDF Database

![img](https://pic4.zhimg.com/80/v2-25bfcfd43e37f394e1a1967b198ebab5_720w.webp)

- 每个材质做了90\*90*180次测量



## 18 高级光线传播与复杂外观建模

### today

* 说主要思路，不谈技术细节（了解即可）

* 高级光线传播

  * 无偏光线传播
    * 双向路径追踪
    * MLT
  * 有偏光线传播
    * 光子映射
    * VCM（结合光子映射和双向路径追踪）
  * 实时辐射度算法   IR

* 复杂外观建模

  * 非表面模型
    * 散射介质
    * 头发/毛发/沙子
  * 表面模型
    * 半透明
    * 布料
    * 有细节度的模型（波动光学）
  * 程序化生成（随用随取）
    * 噪声函数（查询f（x，y，z））

  



- [蒙特卡洛](https://zhida.zhihu.com/search?content_id=182200932&content_type=Article&match_order=1&q=蒙特卡洛&zhida_source=entity)估计出来的结果，不管用多少数量样本，得出的期望永远是真实值，那么就管这个方法是无偏的。

- 其他所有情况都属于有偏

- - 特殊情况（一致的）：当样本数量多到一定情况下，期望值会收敛到正确值



### 高级光线传播

#### 无偏光线传播


**①BDRT（Bidirectional Path Tracing）[双向路径追踪](https://zhida.zhihu.com/search?content_id=182200932&content_type=Article&match_order=1&q=双向路径追踪&zhida_source=entity)**

- - 从光源生成一系列半路径，从摄像机又生成一系列半路径，然后把它们半路径的端点连起来。
  - 优点：当光线传播在光源这半边的路径比较好算时，BDPT的效果就很好
  - 缺点：非常难，运行速度慢

![img](https://pica.zhimg.com/80/v2-1d134e6d8f1af26cfafe29e317437f06_720w.webp)



**②MLT（Metropolis Light Transport）**

- - 统计学上的采样工具：马尔科夫链

  - - 根据当前样本，可以生成一个跟他靠近的下一个样本。可以生成以任意形状的函数为PDF生成样本

  - [马尔科夫链](https://zhida.zhihu.com/search?content_id=182200932&content_type=Article&match_order=2&q=马尔科夫链&zhida_source=entity)应用到光线传播中：已经有一条路径的时候，可以在周围生成和该路径相似的路径（是**一个局部方法：在样本的周围产生新的样本的方法**）

![img](https://pic1.zhimg.com/80/v2-a4248af692c02572ee19d662e0315060_720w.webp)

![img](https://pic2.zhimg.com/80/v2-a4ddc46e2d53ff9d45318171da3473e3_720w.webp)

（左图光源直接照射的只有一部分，场景中几乎是通过[间接光照](https://zhida.zhihu.com/search?content_id=182200932&content_type=Article&match_order=1&q=间接光照&zhida_source=entity)（Diffuse）来照明，那么BDPT计算就非常困难）

- - 优点：特别适合做复杂的困难的光路传播（只要能找到一条光路作为种子，那么就能获得周围更多光路的样本）
  - 缺点：**很难在理论上分析收敛的速度**（无法估计渲染时间），所有操作都是局部，每个像素自己做自己的，这样导致每个像素收敛时间不一样，使得图像看上去脏（下图），因此这个方法不能用于渲染动画

![img](https://pica.zhimg.com/80/v2-d48dcaea7261c996ef9b597b2c1d41d6_720w.webp)



#### 有偏光线传播

**①Photon mapping（[光子映射](https://zhida.zhihu.com/search?content_id=182200932&content_type=Article&match_order=1&q=光子映射&zhida_source=entity)）**

- - 特别适合用来渲染水的caustics，适合用来处理很困难的SDS类型的光线（光线穿过一个Specular再打到Diffuse再打到Specular上）

  - 其中一种实现方法：

  - - 从光源出发，往各个方向发射光线，然后每条光线又继续向不同方向弹射，直到光子打到diffuse表面就停止弹射，然后把所有光子都整理起来

    - 光线从眼睛/摄像机出发，往各个不同方向打出光线路径，然后每条光线路径继续折射/反射，直到他们打到diffuse表面就停止，然后也把这些光子记录下来

    - 将一二的合并做local density estimation（局部密度估计）：光子越集中的地方就越亮，光子越不集中的地方就没那么亮

    - - 对任何着色点，找最近的N个光子

![img](https://pic3.zhimg.com/80/v2-2445f319947dd6a6253276844e7719ba_720w.webp)

（密度计算：N/占的面积）

- - N的取值：过少，图像噪声大；过多，图像糊（bias：偏差）

  - - 这个密度估计其实是不太对的，解决方法：打出的光子要足够的多

![img](https://pica.zhimg.com/80/v2-1034aa1410dd7788d77aa6a04c5adeba_720w.webp)

（比如该着色点最近有100光子，但是当面积足够小的时候，说明集中的越厉害，这时候△A越接近dA，会得到正确的结果）

- - - 结果只要有一点迷糊，那么就是有偏的；只要样本足够多，就能让他收敛到正确的结果，就是一致的

**②VCM（Vertex Connection and Merging）：结合双向路径追踪和光子映射**

![img](https://pic3.zhimg.com/80/v2-119478ce371232b7bd743acee11ccb78_720w.webp)


**③IR（Instant Radiosity）实时辐射度**

- - 很多光源：已经被照射的面都可以认为是光源
  - 光源先打出很多根光线半路径，他们会停在某些地方，就认为停住的地方就变成新的光源；当一个新光源照亮某个地方时，就用所有的光源去照这个着色点

![img](https://pic2.zhimg.com/80/v2-3073780b9a464dbcef44fc9c25109e17_720w.webp)

（相当于用[直接光照](https://zhida.zhihu.com/search?content_id=182200932&content_type=Article&match_order=1&q=直接光照&zhida_source=entity)的方式去得到间接光照的结果）

- - 优点：计算快，适合用来处理[漫反射](https://zhida.zhihu.com/search?content_id=182200932&content_type=Article&match_order=1&q=漫反射&zhida_source=entity)场景
  - 缺点：不能用于处理GLossy材质

###   高级的外观建模

**1.非[表面模型](https://zhida.zhihu.com/search?content_id=182200932&content_type=Article&match_order=1&q=表面模型&zhida_source=entity)（Non-surface）**
**1.1散射介质（Participating Media）：云，雾**

- 光能透过表面到里面的材质是散射材质：比如人的皮肤

![img](https://pic3.zhimg.com/80/v2-66f858949665bb31473e39dffddb8940_720w.webp)



- - - （先不考虑光线穿过云层，云层中还有可能有光源的情况），然后光线打到[小冰晶](https://zhida.zhihu.com/search?content_id=182200932&content_type=Article&match_order=1&q=小冰晶&zhida_source=entity)上会四面八方反射，同时也会接收周围反射来的光

  - **怎么去散射**：Phase Function[相位函数](https://zhida.zhihu.com/search?content_id=182200932&content_type=Article&match_order=1&q=相位函数&zhida_source=entity)决定怎么样去散射，是均匀地还是往后散，还是往前散

![img](https://pic2.zhimg.com/80/v2-7ad5b4af92b96c5d0de7daf3594a3459_720w.webp)

- - **怎么样去渲染：**

![img](https://pic2.zhimg.com/80/v2-772ba1887827593263aa1dc3a7c425e3_720w.webp)


**1.2头发**

- 考虑光线和一个曲线如何作用（而不是考虑和一个面）
- 头发有两种高光：一种是无色的高光，一种是有色的高光

![img](https://pic4.zhimg.com/80/v2-87741e2f4b3b0cc5617f4cbcd15946ad_720w.webp)



**Kajiya -Kay Model**

![img](https://pic2.zhimg.com/80/v2-564d8350a23a88766e49760190b769f9_720w.webp)

- - 把头发丝看成是圆柱，光线打到圆柱上，会往一个圆锥形的方向去散射
  - 这个模型不对，因为**光线能穿过头发发生折射**，于是有了下面这个模型

**Marschner Model：得到一个真实的头发**

![img](https://pic3.zhimg.com/80/v2-c040ce22a65b08e55ff566266fec7178_720w.webp)

- - - R：光线打到圆柱上会有部分被反射，这种反射记作R
    - T：穿进去，穿出去这种穿透行为记作T
    - 一根光线要想穿透头发：那就是先穿进去，然后穿出来，就是穿两次的TT传播方式
    - 一根光线穿进头发里面了，结果发生了往回走的反射：穿透之间发生了一次[内部反射](https://zhida.zhihu.com/search?content_id=182200932&content_type=Article&match_order=1&q=内部反射&zhida_source=entity)

  - 把头发看成是玻璃柱，外层cuticle表皮，内层cortex皮质


![img](https://pic3.zhimg.com/80/v2-947920f81450ee555029e0e624fbc618_720w.webp)

（12：R；134：TT；1356：TRT）

- 光线跟一根头发的作用：[单次散射](https://zhida.zhihu.com/search?content_id=182200932&content_type=Article&match_order=1&q=单次散射&zhida_source=entity)；光线跟多根头发的作用：多次散射

**动物毛发**

![img](https://pic4.zhimg.com/80/v2-984648139b4e048d38233c1b93c2ff43_720w.webp)

（用人的头发模型去应用在动物上，效果是不对的）

- 毛发里的髓质比人类的大，光线进去更容易发生散射
- 双层圆柱模型，中间的圆柱表示髓质

![img](https://pic2.zhimg.com/80/v2-139156a97df66faabe91e2419e406259_720w.webp)

![img](https://pic1.zhimg.com/80/v2-87b8c9b300334c0fd81549032c9906ea_720w.webp)


**1.3 Granular Material（颗粒状材质）**

![img](https://pic1.zhimg.com/80/v2-d898e7740a4d588da7a4d17de322a354_720w.webp)

（各种调料，沙子）

- 目前还没有非常好的解决方法

![img](https://pic4.zhimg.com/80/v2-0f719ce26731c6722f324f0c819c415b_720w.webp)


**2.表面模型**

**2.1半透明材质Semitrparent（玉石，水母）**

- [次表面散射](https://zhida.zhihu.com/search?content_id=182200932&content_type=Article&match_order=1&q=次表面散射&zhida_source=entity)（Subsurface Scattering）：对BRDF的延伸

![img](https://pic3.zhimg.com/80/v2-2fe40e68572ee942a3257b5eade019d6_720w.webp)

- - **Dipole Approximation方法近似次表面散射的效果**

  - - 光线打到某个物体上，就好像物体底下有个光源，然后从底下照亮周围着色点的一片。为了物理上的真实性，在物体的上方还得有一个光源
    - 就相当于用两个光源去照亮着色点周围的结果就像是次表面散射得出的结果

![img](https://pic3.zhimg.com/80/v2-4be785feb157864b6e46d8d377564820_720w.webp)

![img](https://pic3.zhimg.com/80/v2-96c5452166c5b4df959adeeeb52f0980_720w.webp)



![img](https://pic3.zhimg.com/80/v2-fffaf99814026d2a58b41a67e9cdf208_720w.webp)

（干 VS 珠圆玉润）



**2.2 布料材质**

- 布料：不同的纤维缠绕而来

- - fiber缠绕 形成 Ply，Ply缠绕形成Yarn（线）

![img](https://pic1.zhimg.com/80/v2-b4555d229ee40a11847c04f0008701dc_720w.webp)

- - 线的编织/针织方式不同，就形成不同的面料

  - **方法一：**如果认定这种布料是**物体表面**，就可以根据编织的图案就能算出来到底是怎样的，**得出BRDF**

  - - 但是天鹅绒这种材质，所有的纤维都是往外分布的，根本不是一个平面，无法用BRDF来表示

- **方法二：更准确的方法**

- - 织物认为是空间中分布的体积，然后划分成很多个非常小的格子，然后知道每个格子里的纤维朝向分布
  - 再把这些性质转为光线的吸收和散射，就好像在[渲染云](https://zhida.zhihu.com/search?content_id=182200932&content_type=Article&match_order=1&q=渲染云&zhida_source=entity)烟雾

![img](https://picx.zhimg.com/80/v2-889b357dcc729c65d2903af8faa287ff_720w.webp)

（计算量非常夸张）

- **方法三：把每根纤维都渲染出来**（就像人头发），能得出非常真实的效果

（目前为止工业界在不同场合三种方法都有人用）

**2.3Detailed Appearance复杂的材质**


**渲染：**

![img](https://pic4.zhimg.com/80/v2-1d3b2d4f15e28f89693e997fe7b99675_720w.webp)

（渲染出来的结果不真实，因为现实中就算是新品也不可能这么完美）


**现实：**

![img](https://pic3.zhimg.com/80/v2-3401819981a03bd61ef48ef79882f726_720w.webp)

（车上的高光周围的东西是划痕，划痕发生在空气中的灰尘颗粒和车外层的清漆之间）

- 对[微表面模型](https://zhida.zhihu.com/search?content_id=182200932&content_type=Article&match_order=1&q=微表面模型&zhida_source=entity)的BRDF进行完善

![img](https://picx.zhimg.com/80/v2-41643856eff70d48a81163f137dfe8af_720w.webp)

![img](https://picx.zhimg.com/80/v2-19c7f9cec9c843671d1ec8d1b51c6bdb_720w.webp)

- - 微表面模型最重要的是模型表面的[法线分布](https://zhida.zhihu.com/search?content_id=182200932&content_type=Article&match_order=1&q=法线分布&zhida_source=entity)，用正态分布、高斯分布无法体现出真实法线分布（如右图）
  - 法线的分布模型：要符合统计学的规律，又有自带的细节

![img](https://pic4.zhimg.com/80/v2-e23e7e6a45353ca75f32b68c5a47be8b_720w.webp)

（200k的[法线贴图](https://zhida.zhihu.com/search?content_id=182200932&content_type=Article&match_order=1&q=法线贴图&zhida_source=entity)）

![img](https://pic3.zhimg.com/80/v2-66ff8b30e5ad5e6268622896dbc63d0a_720w.webp)

（模拟在车表面漆加亮片之后的效果）

- - 这种方式非常困难，解决方法：

  - - 考虑一个像素覆盖很多微表面，算出像素（一个小的范围）内的法线分布

![img](https://pic3.zhimg.com/80/v2-47363a855e372ff27904ff35f288fc5a_720w.webp)

- - - 范围的大小会显示出不同的法线贴图

![img](https://pic2.zhimg.com/80/v2-f08a4cef777d0b270284cbf21b37f06f_720w.webp)

（蓝色圈的范围最大，显示出来的法线贴图效果就好像高斯分布；范围越小，法线贴图显示出来的就越独特）

![img](https://pic4.zhimg.com/80/v2-37c9065545d39e3336245570afb79a55_720w.webp)



![img](https://pic1.zhimg.com/80/v2-ca34a0b4076a0d4aa8d8d9f1249e7d02_720w.webp)



#### 波动光学：

**细节上的问题：用白光照射金属片，然后将反射出来的效果方法，会发现不是纯白的**

![img](https://picx.zhimg.com/80/v2-aedf84cbb5448afa9c588a7b850de035_720w.webp)

<img src="https://pica.zhimg.com/80/v2-de537f6d2f7caec74e54b839ac8b0ff2_720w.webp" alt="img" style="zoom:50%;" />

![img](https://picx.zhimg.com/80/v2-321cd7c9544058ed58a7572317851821_720w.webp)

（不连续的特点）



####  [程序化生成](https://zhida.zhihu.com/search?content_id=182200932&content_type=Article&match_order=1&q=程序化生成&zhida_source=entity)表面（Procedural Appearance）：

- 这里的Procedural是指：用一定的方式来指导材质生成，而不需要真正去生成；等到需要的时候去查（就比如空间中的f(x)函数，我要用的时候给x,y,z值，然后去查对应的f(x)的值就行），随用随取

- 对应的这类函数是**三维noise函数**

- > 也就是说切开木头可以看到内部的纹理

![img](https://pica.zhimg.com/80/v2-c1b9affd9aaaf1c8a9d1f8aa5421b670_720w.webp)

- 噪声函数用得最广泛的是Perlin Noise，Voronoi





## 19 **相机与透镜** 

### today

* 19~20 主要是科普，拓展一些认知，了解一下
* 成像 = 合成 + 捕捉

### 相机

最简单的成像工具

**部件**

- 快门Shutter：控制光在多少分之一秒内进入相机
- **传感器Sensor：捕捉光，记录的是Irradiance**，即传感器每一点记录了来自物体所有方向的光

#### **[小孔成像](https://zhida.zhihu.com/search?content_id=182201371&content_type=Article&match_order=1&q=小孔成像&zhida_source=entity)** 

- 针孔相机的原理
- 拍出的图像是没有深度的（得不出某些地方模糊的效果，比如景深）

###  FOV（Field of view）[视场](https://zhida.zhihu.com/search?content_id=182201371&content_type=Article&match_order=1&q=视场&zhida_source=entity) 

- 视场：成像的角度范围
- h：传感器宽度
- f：传感器和小孔之间的距离，焦距
- 焦距f越小的时候，FOV角度越大，能成像更大范围，也就是广角相机的原理

![img](https://pic2.zhimg.com/80/v2-b14b544c992e4fe4ec9d08ecaa0b82c7_720w.webp)

- - 通常以35mm长度的传感器为基准，通过定义焦距的方式，来定义视场（这个基准不是指手机的）

![img](https://pic4.zhimg.com/80/v2-c7293ad8760d739d905e2ffee1610bb1_720w.webp)

（17,50是指焦距）

- - 同样焦距（[focal length](https://zhida.zhihu.com/search?content_id=182201371&content_type=Article&match_order=1&q=focal+length&zhida_source=entity)）下，传感器长度越小，成像范围也变小。但是通常情况下我们固定传感器的长度，用焦距去衡量FOV


传感器和胶片不是一个概念：传感器只负责记录每个点收集到的Irradiance有多大，胶片（film）是存成图片的格式

![img](https://pic2.zhimg.com/80/v2-2b3e0a968f9c67023f086f1cd4c8ec27_720w.webp)



- 手机想尽可能达到相机看到的成像范围，相应的焦距f要变得很小。

![img](https://pic3.zhimg.com/80/v2-35b8e834f5d3f7b1965bf7b92a67382c_720w.webp)



###  曝光Exposure

![img](https://pic2.zhimg.com/80/v2-7a0b4b37e16bd06f054efc0d179114a9_720w.webp)

- 在一个比较暗的场景，曝光时间越长，最后也能得到一个比较亮的场景
- （[辐射度量学](https://zhida.zhihu.com/search?content_id=182201371&content_type=Article&match_order=1&q=辐射度量学&zhida_source=entity)角度）从曝光公式中可以看出，记录的**Time不是单位时间，是总时间**。因此**Exposure接收的是能量，而不是功率**



####  影响曝光的因素： 

- **光圈的大小（Aperture Size）**：挡光的程度

- - **F-Shop（F-Number）：描述光圈大小**
  - 表示方法：

![img](https://picx.zhimg.com/80/v2-cbc26e43b7ce454947a091bd00f71d9b_720w.webp)

- - **如果光圈越大，被遮挡的光越少，进光量越多，那么曝光的程度就会越高。**
  - **[f数](https://zhida.zhihu.com/search?content_id=182201371&content_type=Article&match_order=1&q=f数&zhida_source=entity)越大，光圈越小**

![img](https://pica.zhimg.com/80/v2-86e005783a94055af784c6a76feff1f6_720w.webp)

- - **光圈的定义：N = 焦距f ÷ 光圈的直径A**

![img](https://picx.zhimg.com/80/v2-dc6bb363c46e43b3435b8b9fd8886c4b_720w.webp)

- **快门的速度（Shutter Speed）**：理解成快门开放时间

- - 快门速度越快，快门开放的时间就越短，从而就越少光进来

  - 可以实现**[运动模糊](https://zhida.zhihu.com/search?content_id=182201371&content_type=Article&match_order=1&q=运动模糊&zhida_source=entity)**效果

  - - 物体在高速运动，快门打开的时候和快门关闭的时候位置不同，那么这中间过程被记录下来，传感器会对其起平均作用，最终得到的效果就是模糊
    - 同样的运动速度，曝光时间越长，运动模糊越严重；同样的曝光时间，运动速度越快，运动模糊越严重

  - 问题：Rolling Shutter

  - - [机械快门](https://zhida.zhihu.com/search?content_id=182201371&content_type=Article&match_order=1&q=机械快门&zhida_source=entity)打开关闭的速度再快，也一定有一个打开到关闭的过程；当物体运动的速度跟快门打开的速度差不多甚至更快，这样就会出现**扭曲**问题。因为图像上不同位置有可能记录的是不同时间的光

![img](https://pica.zhimg.com/80/v2-22ab78901b8edb4c881598a7d16da9aa_720w.webp)

（螺旋桨扭曲）

- **ISO gain（增益，感光度）：简单线性变化**

- - 算是一个后期处理，简单理解为对最终图像程了一个倍数
  - 照片本质是信号，ISO越大，在放大信号的同时，也会放大噪声

![img](https://pic3.zhimg.com/80/v2-2ab67a2ef850f154796ad51965c53e28_720w.webp)

![img](https://pica.zhimg.com/80/v2-2fae151f598bfc81e705db5cd6ca99ae_720w.webp)

- （表格中每一列的数值，拍出来的曝光度都差不多）
- 但不代表光圈为4，快门速度为1/60，与光圈8，快门速度1/15拍出来的照片就一模一样。因为大光圈有景深问题，快门时间会影响运动模糊
- 景深和运动模糊是需要权衡的
- 

###  快门时间的简单应用：高速摄影，低速摄影

#### **高速摄影：**

![img](https://picx.zhimg.com/80/v2-ea4072381200b1515e11f83b04609149_720w.webp)

- 高速运动物体需要用**非常小的快门速度**来捕捉，因此为了补偿曝光度，需要使用**大光圈或者提高ISO**



#### **[低速摄影](https://zhida.zhihu.com/search?content_id=182201371&content_type=Article&match_order=2&q=低速摄影&zhida_source=entity)（延时摄影）：**

![img](https://pic3.zhimg.com/80/v2-f06f470f81708e57bfee27f3aaa6d36a_720w.webp)



- 快门时间非常长，可以用非常小光圈



###   薄膜透镜

理想透镜性质：

- 所有平行射入透镜的光都会集中于一点，称该点为焦点

- 所有从焦点射入透镜的光都会平行射出([光路可逆性](https://zhida.zhihu.com/search?content_id=182201371&content_type=Article&match_order=1&q=光路可逆性&zhida_source=entity))

- （这里独特的假设）薄的透镜可以任意改变焦距

- - 现实中大部分相机都是一个透镜组，可以做到改变焦距
    利用这些性质可以得到理想透镜的成像规律：

![img](https://pic1.zhimg.com/80/v2-e61af6e2571d0546b94d9998400a807e_720w.webp)

- Z0：物距
- Zi：像距
- 这个式子可以利用相似三角形性质推导出来

![img](https://pic2.zhimg.com/80/v2-d1e8edfff65963ce3e560a2426e7c921_720w.webp)

###  Circle of Confusion（CoC）

**用来解释景深模糊的原因**

- 传感器平面不在物体真正成像平面上时，便会出现模糊。

![img](https://pic4.zhimg.com/80/v2-bad7968efa672ef0797615eef670901b_720w.webp)

（近视？）

![img](https://pic4.zhimg.com/80/v2-0d39a68862f05aa19a7b343a06fb137b_720w.webp)

- - （在成像平面Image之后，成像[点投影](https://zhida.zhihu.com/search?content_id=182201371&content_type=Article&match_order=1&q=点投影&zhida_source=entity)到传感器上变成了线，3维上看是圆，此时传感器也能接收到其他点投影的圆，圆与圆之间叠加，于是就不知道这个成像点在哪。最终的圆就是CoC，Confusion这个词就很生动形象）
  - 知道C，A，Zi，Zs，就能求出d'。（Zs：传感器里透镜多远）
  - **CoC的大小与A有关，CoC大小与透镜的A成正比。因此可知，看到的东西模不模糊取决于光圈的大小。CoC越大，越模糊**

###  [光线追踪](https://zhida.zhihu.com/search?content_id=182201371&content_type=Article&match_order=1&q=光线追踪&zhida_source=entity)中实现景深

![img](https://picx.zhimg.com/80/v2-4b4d319e6fcb971d10ce3dba9228be53_720w.webp)

![img](https://pic3.zhimg.com/80/v2-13104076bb9757b39ad03985e710913a_720w.webp)

1. 首先定义传感器成像平面大小，透镜的焦距和光圈大小，定义物距z0
2. **知道焦距f，物距z0，可以根据透镜公式求出像距zi**
3. 在Sensor平面取一个点x'，透镜上选一个点x"，两点之间连线，然后就能知道这条线通过透镜能打到哪（打到x"'点上）
4. 计算x''到x'''这条光线带有的Radiance



###  景深（Depth of Field）：成像清晰的一段范围

概念：当相机的镜头对着某一物体[聚焦](https://link.zhihu.com/?target=https%3A//baike.baidu.com/item/%E8%81%9A%E7%84%A6/47127)清晰时，在镜头中心所对的位置垂直镜头轴线的同一平面的点都可以在胶片或者接收器上形成相当清晰的图像，在这个平面沿着镜头轴线的前面和后面一定范围的点也可以结成眼睛可以接受的较清晰的像点，把这个平面的前面和后面的所有景物的距离叫做相机的景深。光轴平行的光线射入[凸透镜](https://link.zhihu.com/?target=https%3A//baike.baidu.com/item/%E5%87%B8%E9%80%8F%E9%95%9C)时，理想的镜头应该是所有的光线聚集在一点后，再以锥状扩散开来，这个聚集所有光线的一点，就叫做焦点。在焦点前后，光线开始聚集和扩散，点的影像变成模糊的，形成一个扩大的圆，这个圆就叫做[弥散圆](https://link.zhihu.com/?target=https%3A//baike.baidu.com/item/%E5%BC%A5%E6%95%A3%E5%9C%86/5089197)。

- **用大/小光圈会影响模糊的范围**

- 景深就是指光经过透镜，打到某一个成像平面，在成像平面前后一段区域内，我们认为这段区域的CoC都是足够小的。（可以理解为CoC和pixel一样小时，形成的image就是锐利的）

- - 在CoC足够小的这段范围内，看到的物体都是清晰的。景深对应的就是CoC足够小的这一段

![img](https://pic3.zhimg.com/80/v2-736ae27dd982ee497111a095158cefea_720w.webp)

![img](https://pic4.zhimg.com/80/v2-586f919b775b8d21f9856bd60b806e37_720w.webp)



- **光圈越小，景深越大**（光圈越小，那么成像越清晰，从而可以知道景深的范围就越大）
- **相机和拍摄对象之间的距离越近，景深越浅**



###  全光函数（The Plenoptic Function）：描述人眼看到的所有东西

①在某个点，往某个方向看（**P(θ，φ)**用于描述我们能看到的所有东西）

![img](https://picx.zhimg.com/80/v2-1bd7cab198d41b6e724861efec3d3fe5_720w.webp)



②改进一下，引入**[波长λ](https://zhida.zhihu.com/search?content_id=182201371&content_type=Article&match_order=1&q=波长λ&zhida_source=entity)**，画面就有了颜色

![img](https://pic1.zhimg.com/80/v2-a69cc748ea3f691e6b6bf91f22baf5ea_720w.webp)


③再加上**时间t**让画面可以看到不同时间的场景，就形成了电影

![img](https://pica.zhimg.com/80/v2-003ced804efbeba197d5aee83b38c81e_720w.webp)



④观察者的位置不固定，引入三维空间坐标，就形成了[全息电影](https://zhida.zhihu.com/search?content_id=182201371&content_type=Article&match_order=1&q=全息电影&zhida_source=entity)（引入摄像机的位置**Vx、Vy、Vz**，可以在任意位置观察场景）

![img](https://picx.zhimg.com/80/v2-4fd7c619135918e4fbe44a1a5f8d8fa7_720w.webp)



**最后得出：整个世界是一个七个维度的函数。在任意位置，往任意方向看，在任意时间内看到不同的颜色，这就是我们看到的世界，用全光函数描述出来。**

![img](https://pic2.zhimg.com/80/v2-f69c40ee2a9c2768ba695a497b6d900f_720w.webp)

- 全光函数不一定是离散的

- 可以从全光函数里提取出一定的信息，来表示更复杂的光。

- **光场只是[全光函数](https://zhida.zhihu.com/search?content_id=182201371&content_type=Article&match_order=5&q=全光函数&zhida_source=entity)的一部分（2维的位置和2维的方向）**

- - **3D的物体的物体表面相当于一个[2维平面](https://zhida.zhihu.com/search?content_id=182201371&content_type=Article&match_order=1&q=2维平面&zhida_source=entity)**

###   光场

- 两个点能确定一条光线
- 描述物体能被看到的所有情况：描述这个物体在包围盒里，他在任意位置，往任意一个方向，发过去的光线；根据光路可逆性，我们就可以知道在任何方向看到的这个物体长什么样
- **光场定义：记录在任意位置，往任意方向发出的光的强度**

![img](https://pic4.zhimg.com/80/v2-b485a4471fe8a00c98998e26cc6de351_720w.webp)

- 我们同样可以通过获取一束光在两个平行平面（s，t）和（u，v）上的位置来确定光的位置

- - 因为两个点就能确定一条光线

![img](https://pica.zhimg.com/80/v2-4bf5352c8f2e3955b25ea0b66df9c0a6_720w.webp)

（参数化表示方法）



从不同角度看成像画面，下图的意思是，假设成像平面在st的右边。

1. uv平面上固定一点，从不同方向看st面
2. 在uv上不同位置，看向st里的某个点

![img](https://picx.zhimg.com/80/v2-3bc9c238b20d94249489a04b637d6553_720w.webp)
苍蝇的眼睛的成像原理就是一个光场

###   [光场相机](https://zhida.zhihu.com/search?content_id=182201371&content_type=Article&match_order=1&q=光场相机&zhida_source=entity)

**光场相机原理** （其实就是光场原理）

- 把像素替换成透镜，将来自各个方向不同的光分开记录下来

- - 记录的就是各个方向的Radiance

- 感光元件从像素位置往后挪，每个像素上吸收了来自各方向上的光（Irradiance）聚焦与像素点上，将原本的像素替换成微透镜，再把这些光分散到一片区域上，感光元件再把这些光记录下来


**最重要的功能：支持后期重新聚焦（先拍照，后期可以动态调节聚焦，光圈） — 原因：光场相机记录了整个光场的信息，光场就是记录了所有的进入到相机的光的位置、方向**

![img](https://pic1.zhimg.com/80/v2-0cbdc33dc7fd4ea8eb635620071c7dee_720w.webp)

（从透镜往左边看，就是一个光场）


光场相机得到的照片：

![img](https://picx.zhimg.com/80/v2-68212065cb1d958d2534ee9dcfcac4f9_720w.webp)



怎么得到一张原始照片？

- 每个透镜选一条光线，得到的结果记录在对应的像素上

- - 如果都选**最底下**的那条光线，得出来的照片就相当于是**照相机从下往上拍**

 **↓**

取不同光方向呈现出的照片，就相当于虚拟移动相机的位置拍出来的

![img](https://pic1.zhimg.com/80/v2-760831654ee9d23aa54d67ccdc79b874_720w.webp)

缺陷：

- 分辨率低（经过透镜后的光是打到一块区域上的。比如：原本是1个像素记录一个信息，现在是100个像素记录一个信息），对胶片要求高
- [微透镜](https://zhida.zhihu.com/search?content_id=182201371&content_type=Article&match_order=2&q=微透镜&zhida_source=entity)制造成本高



## 20 光场、颜色与感知

Color and Perception

#### today

* 光场
* 颜色
  * 是什么
  * 颜色感知
  * 颜色匹配
  * 颜色空间



- 不同波长对应不同折射率

- 图形学仅关心光谱中的可见光（400~700nm）

- 谱[功率密度](https://zhida.zhihu.com/search?content_id=182201691&content_type=Article&match_order=1&q=功率密度&zhida_source=entity)（SPD）：描述任何光在不同波长的分布

- - 性质：线性（可叠加）

![img](https://picx.zhimg.com/80/v2-66e41cd0d47560b31d9f778970ac5cc3_720w.webp)

####   颜色

**颜色其实是人的感知**



####  人怎么感知到颜色？

- 人眼结构类似相机，希望成像的东西在视网膜上

- - 瞳孔 → 光圈

  - 晶状体 → 透镜

  - 视网膜 → 成像平面

  - - 有感光细胞

    - - [视杆细胞](https://zhida.zhihu.com/search?content_id=182201691&content_type=Article&match_order=1&q=视杆细胞&zhida_source=entity)

      - 视锥细胞（少）：感知颜色

      - - S，M，L对光谱中不同波长的感知能力不同

![img](https://pic2.zhimg.com/80/v2-979a55ca30a3998f9a18662f6158ceb7_720w.webp)

![img](https://pic2.zhimg.com/80/v2-472aa19730b92722cdd46ad5b0242991_720w.webp)



- **不同人眼睛里的SML分布区域，数量不同**

![img](https://pic2.zhimg.com/80/v2-6fedfb10953c6343d72a33c68544fbfd_720w.webp)

####  人眼感知的结果：

![img](https://pic1.zhimg.com/80/v2-88ea69e1dff007bd05f653696bc18174_720w.webp)


在λ位置，对应的光强分别和S/M/L的感知强度相乘，然后积分
**人眼看到的不是光谱，而是（S，M，L）三个数**

####  Metamerism（[同色异谱](https://zhida.zhihu.com/search?content_id=182201691&content_type=Article&match_order=1&q=同色异谱&zhida_source=entity)）

- 两种光线具有的光谱（SPD）不同，但是我们看到的S，M，L都是相同的

####  Color Matching：

- 调和不同光谱，使得最后看到的颜色和另外一种一样

![img](https://pic1.zhimg.com/80/v2-cddd0d7fbc17d29dd646d90e562f4a10_720w.webp)

- 加色系统

- - 通过调整[RGB三原色](https://zhida.zhihu.com/search?content_id=182201691&content_type=Article&match_order=1&q=RGB三原色&zhida_source=entity)的比例来混合出不同颜色

![img](https://pic1.zhimg.com/80/v2-fd288cbbd51fb37aec9143b41ddf95b8_720w.webp)



- **实验一：**

![img](https://pic1.zhimg.com/80/v2-23683a6270acf7fb47129e824bcb0e62_720w.webp)



- **实验二：**有一种情况是怎么混也得不出左边的颜色，这说明颜色[比例系数](https://zhida.zhihu.com/search?content_id=182201691&content_type=Article&match_order=1&q=比例系数&zhida_source=entity)可能是负的。但是这是加色系统，没有负数，就可以通过给原色加色的方法 相当于右边的某个原色贡献是负的。

![img](https://pica.zhimg.com/80/v2-6728ef04413bfc3b9f8e392bd14a56ee_720w.webp)

**通过这种情况，发明了CIE RGB系统：做颜色匹配**

- 取固定波长（比如450），这个波长的颜色就是我要匹配的颜色

- - 这个颜色我需要用x蓝色，y绿色，z红色可以混合出来

![img](https://pic1.zhimg.com/80/v2-7d6f08ff1b6844b94ef2b312cd1f45de_720w.webp)

####  颜色空间

**①CIE XYZ系统**

- 人为定义的一套RGB颜色匹配系统，覆盖了所有可见光

![img](https://pic3.zhimg.com/80/v2-58d2d2d06ef3b8577c18ad98d2290e90_720w.webp)

（y表示颜色亮度）

- 将颜色亮度[可视化](https://zhida.zhihu.com/search?content_id=182201691&content_type=Article&match_order=1&q=可视化&zhida_source=entity)，但是三维的不好做，需要降维

- - 将xyz归一化

![img](https://picx.zhimg.com/80/v2-40813ac434979a8a507ae122686cee7f_720w.webp)

- - - 白色是最不纯的颜色，纯的颜色在形状边界

![img](https://pic1.zhimg.com/80/v2-4e5f90bc0e0cd7c4cc91573e49e3e742_720w.webp)

**
②标准颜色空间（Standardized RGB，sRGB）**

- 标准RGB系统，但是形成的色域有限
- sRGB只能表示上图色域的一部分

![img](https://pic1.zhimg.com/80/v2-7ff7db378a3b184189b2f276730171c6_720w.webp)

**③其他颜色空间**


**3.1 HSV取色器：适合艺术家**

- 通过色调（H）、饱和度（S）、明度（V）来定义颜色空间的一种颜色标准

![img](https://pic1.zhimg.com/80/v2-087a0e9f7abe8f79a59b9f7d3d3c7b3c_720w.webp)

- - H：色调
  - S：越饱和就越接近单一颜色，越不饱和就接近白色（混合颜色）
  - V：亮度

**
3.2 CLELAB Space**

![img](https://pica.zhimg.com/80/v2-7bd0ff92bb91a676fae5d886fe460f7c_720w.webp)

- L：亮度，0黑，100白
- a：表示红、绿
- b：表示蓝、黄


**两个轴的极端是互补色** — [互补色](https://zhida.zhihu.com/search?content_id=182201691&content_type=Article&match_order=2&q=互补色&zhida_source=entity)是实验得出来的

- 跟人脑相关，**人脑可以自动达到互补色的结果**

- 例子一：国旗互补色

- - 盯着白点看10s，然后切换到白色，能看到正常颜色的红旗

  - - 人**脑会自动给他加上互补色**（蓝 → 黄，绿 →红）（星星那看到的是黄色，其他区域是粉红）

![img](https://pic3.zhimg.com/80/v2-b69379e9b4f1e25c905e93864f253822_720w.webp)

- 例子二：利用互补色给忍者神龟补色

![img](https://picx.zhimg.com/80/v2-24c6b5dbfd85e154bc34c6c32718bac9_720w.webp)

盯着白点看10s，切换到

![img](https://pica.zhimg.com/80/v2-453b046821250c8d574ebcd1c808b9a2_720w.webp)

（这张图有[灰度信息](https://zhida.zhihu.com/search?content_id=182201691&content_type=Article&match_order=1&q=灰度信息&zhida_source=entity)，所以在给他补色的时候人眼会加上灰度值信息的补色— **绿色**）

- 例子三：A，B两个格子的颜色一样

![img](https://pic4.zhimg.com/80/v2-a3fdd5a5acbd02019f4031d1b03912b1_720w.webp)

![img](https://pica.zhimg.com/80/v2-d3d3a133475e1666509b58f7a1ca3b34_720w.webp)

（都挡住）



![img](https://pic1.zhimg.com/80/v2-2150627c6a0eb484a1fb06bcb64d559a_720w.webp)

![img](https://pic4.zhimg.com/80/v2-9b2d5efea68284c8288b804279f0aa9d_720w.webp)

（两个区域的颜色是一样的）

**（例子三说明颜色是相对的，颜色是人脑感知的）**



**3.3 CMYK(减色系统)：用于印刷**

- 所有颜色混在一块，越混越黑
- 由C靛蓝、M品红、Y黄色三种颜色混合出其他颜色再加上黑色组成，广泛应用于印刷

![img](https://pic2.zhimg.com/80/v2-c7ea720261ba7e965a5feace47e3d993_720w.webp)

- CMY三种混在一起就能得到黑色，那么我们为什么还要带上K呢？

- - 因为印刷上黑色便宜，[彩色墨水](https://zhida.zhihu.com/search?content_id=182201691&content_type=Article&match_order=1&q=彩色墨水&zhida_source=entity)比黑色贵


还没有提的：HDR（高[动态范围](https://zhida.zhihu.com/search?content_id=182201691&content_type=Article&match_order=1&q=动态范围&zhida_source=entity)图像），[伽马矫正](https://zhida.zhihu.com/search?content_id=182201691&content_type=Article&match_order=1&q=伽马矫正&zhida_source=entity)



## 21 动画与模拟（基本概念、质点弹簧系统、运动学）

### today

计算机动画入门

* 历史

* 基本制作方法（关键帧）

* 物理模拟

* 运动学

* rigging（绑定）

  > 在三维计算机图形和动画制作中，"rigging" 翻译为中文是“绑定”。这是指为三维模型创建一个控制系统的过程，包括建立骨骼、添加控制点和定义各种控制器，以使动画师能够通过操纵这些控制器来动态地改变模型的姿势和形状。



电影：24FPS
视频：30FPS
游戏：30、60+
射击类游戏要求60以上，甚至要求144HZ
虚拟现实对帧率要求非常高，要求两只眼睛达到90FPS。如果想带着头不晕的话

###  动画历史 

- 1931，Phenakistoscope圆盘，通过转动圆盘来做动画

![img](https://pic2.zhimg.com/80/v2-dce2a44471fb9fe946eaf5fcef656677_720w.webp)

- - 右边是我们能看到的，通过旋转时钟，我们能看到不同的动作，从而形成动画

- 1878，第一部电影Sallie Gardner，早期电影用来做科学研究，而不是用来娱乐

- 1937，第一部剧场版手绘电影-[白雪公主与七个小矮人](https://zhida.zhihu.com/search?content_id=182201932&content_type=Article&match_order=1&q=白雪公主与七个小矮人&zhida_source=entity)

- - 每秒24帧

- 1963，第一个计算机生成的动画

- 1972，早期计算机动画 — 人脸动画

- 1993，侏罗纪公园（里程碑作品）

- - 电脑生成的恐龙直接使用在电影里

- 1995，玩具总动员，第一部完全计算机生成的CG动画电影

- - 用的光栅化方法，Feature-Length：完整电影长度

###  动画是怎么做的呢？

####  ①Keyframe Animation[关键帧动画](https://zhida.zhihu.com/search?content_id=182201932&content_type=Article&match_order=1&q=关键帧动画&zhida_source=entity)

- 关键帧定义整个动画的走向
- 早期由最厉害的艺术家画出关键帧，再让助手把中间的过程补齐
- 本质：插值的方法

####  ②Physical Simulation物理模拟/仿真

- 牛顿定律

![img](https://pica.zhimg.com/80/v2-0d8447cded709d389189acc62d085abc_720w.webp)

- 正确建立真实的受力模型来模拟出真实的动画系统

- - 例子：布料模拟、流体模拟

![img](https://pic2.zhimg.com/80/v2-87bcdff498db608f4e49499c7b2c781f_720w.webp)


（模拟得不好，就有反物理现象：比如穿模）

[流体模拟](https://zhida.zhihu.com/search?content_id=182201932&content_type=Article&match_order=2&q=流体模拟&zhida_source=entity)：

1. 先模拟这些水是怎么运动的，水滴在各种地方是怎么形成的
2. 模拟了水的位置、形状等之后，拿去渲染，得出最后的结果

####   ③Mass Spring System[质点弹簧系统](https://zhida.zhihu.com/search?content_id=182201932&content_type=Article&match_order=1&q=质点弹簧系统&zhida_source=entity) （最简单，也非常实用的系统） 

- **例子：**1.头发模拟
  2.

![img](https://pic1.zhimg.com/80/v2-7aabe7efd487a7b129ec46d121bc4bb4_720w.webp)

![img](https://pic3.zhimg.com/80/v2-e4bdd1bd553c69889b7ab5aa8bbae3f8_720w.webp)

- **质点弹簧系统：**是一系列相互连接的质点和弹簧

- - 最基本的单元：一个弹簧，左右各连着一个质点


**1、理想情况，弹簧没有长度**

![img](https://pic1.zhimg.com/80/v2-d50ce42288d739a3fa27cc5afdfd08ae_720w.webp)

- - [胡克定律](https://zhida.zhihu.com/search?content_id=182201932&content_type=Article&match_order=1&q=胡克定律&zhida_source=entity)：k劲度系数

**2、正常情况：考虑应用在a上的力**

![img](https://pic4.zhimg.com/80/v2-2d781bf45fdecde15da4adf4cd4a9473_720w.webp)

- - 问题：这个弹簧会永远的运动下去
  - 解决：那就加一个摩擦力

**3、加入阻尼**

![img](https://pic2.zhimg.com/80/v2-830ef6ee05efe15f6221572ee863679f_720w.webp)

（计算机图形学中，**如果x表示为位移，x上一点是速度（一阶导数）点两个点是加速度（二阶导数）**）

<img src="https://pica.zhimg.com/80/v2-940d53e1706ca92dcbdfa3691778a55c_720w.webp" alt="img" style="zoom: 67%;" />

- - 问题：只描述了外部的力，无法描述弹簧内部的力（内部的损耗）

**4、完善弹簧系统**
（应用在b上的力：a跟b被拉开了，那a肯定会想办法往b靠）

![img](https://pic4.zhimg.com/80/v2-ecead6044696610a68399403eee98109_720w.webp)



- （假设ab被拉开，那么b的力是往左的，以左为正方向，a想往b靠，a上的力是往右）

- 要考虑弹簧内部的力，考虑的是相对速度

- 一个向量点乘一个单位向量，就是往这个方向做投影，就可以得到投影长度

- - 相对速度投影在ab方向的速度是多少

**5、各种弹簧可以组成不同形状**

![img](https://pica.zhimg.com/80/v2-6af860d62669a59333a2a9a8b9450c74_720w.webp)

- **布料**可以抵抗切变，而这种弹簧形状不可以

![img](https://pic4.zhimg.com/80/v2-0fe10f55ee9cb2e97789b2aa3e7f260d_720w.webp)

- - out-of-plane bending 布有一种对抗“折”的力，这个也没有

- **改进1**：加入斜对角线

![img](https://pic2.zhimg.com/80/v2-2aa4506ca045301688995ea71df964db_720w.webp)

- - （能抵抗切变，但是结构不对称（有点[各向异性](https://zhida.zhihu.com/search?content_id=182201932&content_type=Article&match_order=1&q=各向异性&zhida_source=entity)的意思））

- **改进2：**再加另一个方向的斜对角线

![img](https://pic2.zhimg.com/80/v2-b4547c6f66ab5fe1afca28fed921ee5f_720w.webp)

- - 但是仍然不能抵抗非平面的弯曲（折）

- **改进3：**加入跳跃连接的点，隔一个支点加一个弹簧

![img](https://pic1.zhimg.com/80/v2-b04924810a3fbd9efe86c7da3eae9f1c_720w.webp)

- - 蓝线起主要作用，红线起辅助作用
  - **这种能够模拟布料了**


**6、[有限元方法](https://zhida.zhihu.com/search?content_id=182201932&content_type=Article&match_order=1&q=有限元方法&zhida_source=entity)FEM**

- 广泛应用于车子碰撞
- 方便制作力的传导



### 粒子系统

粒子之间的碰撞，粒子受到的风力等情况

![img](https://pica.zhimg.com/80/v2-a6e1b5972a21f27060a205c0143c0370_720w.webp)

####   粒子的生成方法：

1. 生成粒子
2. **计算每个粒子的力（内部，外部）— 难**
3. 更新任何一个粒子的位置和速度
4. 移除死亡的粒子
5. 渲染出每一帧的粒子

####  粒子之间的作用力

- 引力、[斥力](https://zhida.zhihu.com/search?content_id=182201932&content_type=Article&match_order=1&q=斥力&zhida_source=entity)、重力、电磁力……
- 摩擦力、空气阻力、粘滞力
- 跟墙、容器、物体等碰撞

####  粒子的延伸

- 在一个很大规模的区域，然后又很多重复的东西，这些东西也可以理解为粒子

- - 比如鸟群，鱼群，蜜蜂

![img](https://pic2.zhimg.com/80/v2-53b30d5f732c5c01d65cc37c3b5ecf59_720w.webp)

- 任何一只鸟不愿意落单，一只鸟会找到它周围的鸟，并试图融入进去（左图）
- 但是任何一只鸟又不希望离得太近（中图）— 类比斥力
- 朝向统一（右图）



### 运动学 （如何做出一种动画，模拟真实的骨骼运动） 

####  正向运动学

![img](https://pic2.zhimg.com/80/v2-c8fd93f9946ade1b6d72e4b6fcd7b283_720w.webp)


三种不同的关节：

- Pin：定点，像钉子。在定住的这个平面内旋转
- Ball：可以绕着关节3维的旋转，不发生在平面内
- Prismatic joint：可以拉长关节
- 做法：告诉每个关节怎么运动（θ1，θ2的值），然后求最后尖端P的位置

![img](https://pica.zhimg.com/80/v2-6394f6798ac213bb010535f63c43dff6_720w.webp)

- 先算Pz的位置，然后再算P点的位置

- 通过改变参数来实现骨骼的动画就被称为[正向运动学](https://zhida.zhihu.com/search?content_id=182201932&content_type=Article&match_order=2&q=正向运动学&zhida_source=entity)

- - 但是对艺术家不友好，不太直观，因此逆运动学应运而生

####  逆向运动学![img](https://pic2.zhimg.com/80/v2-cffda7598a1d5769d7ec1f3afe1035d1_720w.webp)

- 可以直接控制尖端P来控制参数
- 做法：固定P点，求中间θ1，θ2多少
- 但是计算难，[逆运动学](https://zhida.zhihu.com/search?content_id=182201932&content_type=Article&match_order=2&q=逆运动学&zhida_source=entity)的解不唯一

![img](https://pica.zhimg.com/80/v2-0338a28e2fb27f027a4c674f2aab3854_720w.webp)

- 优化：通过[随机化算法](https://zhida.zhihu.com/search?content_id=182201932&content_type=Article&match_order=1&q=随机化算法&zhida_source=entity)（[优化方法](https://zhida.zhihu.com/search?content_id=182201932&content_type=Article&match_order=1&q=优化方法&zhida_source=entity)、**梯度下降**）等方法来解决问题，**并不使用纯数学**的方法来暴力解决

![img](https://picx.zhimg.com/80/v2-2d7011be15a3b4eb2681dcbb28b8349b_720w.webp)

- 应用：Style-Based IK

###  Rigging

- 对一个形状的控制（类似操纵木偶）
- 在模型上增加控制点，让人们能够方便的调整模型的动作
- 应用：软选取，[蒙皮](https://zhida.zhihu.com/search?content_id=182201932&content_type=Article&match_order=1&q=蒙皮&zhida_source=entity)


**Blend Shapes：本质是Blend控制点以及周围被影响的东西**

- 先前有一个形状，后来有一个形状，这两个形状之间做插值，就是Blend Shapes
- 就是两个关键帧做BlendShapes，使其流畅过渡

###   Motion Capture动作捕捉

- 在真人身上放置控制点，让这些控制点的位置直接反映到虚拟对象上
- 建立真人与虚拟角色的关系

![img](https://pica.zhimg.com/80/v2-777f50c4599b3400fa6cbb0b3df7aa6a_720w.webp)

- - 优点：

  - - 可以快速捕捉大量数据
    - 较为真实

  - 缺点：

  - - 复杂、昂贵
    - 动作常常会不满足要求，还需要后期调整
    - 捕捉条件限制

![img](https://pic2.zhimg.com/80/v2-8641263d35810cfd00985b935d2e05b7_720w.webp)


（应用最广泛的是光学的方法，Markers贴在衣服上）

![img](https://pic2.zhimg.com/80/v2-9be072833a2d713a0eef1adce045e945_720w.webp)



得到了这些数据：

![img](https://pic4.zhimg.com/80/v2-125df226262807d3cb7a6d2a08b443c7_720w.webp)

（每条线代表每个控制点在3维空间下不同时间的位置）

###  [恐怖谷效应](https://zhida.zhihu.com/search?content_id=182201932&content_type=Article&match_order=1&q=恐怖谷效应&zhida_source=entity)：动画的挑战


如果利用动捕做出来的动画过于真实了怎么办

- [恐怖谷理论](https://zhida.zhihu.com/search?content_id=182201932&content_type=Article&match_order=1&q=恐怖谷理论&zhida_source=entity)是一个关于人类对机器人和非人类物体的感觉的假设，它在1970年由日本机器人专家森政弘提出。研究表明，由于机器人与人类在外表、动作上相似，所以人类会对机器人产生正面的情感；而当机器人与人类的相似程度上升到一个特定程度的时候，人类对他们的反应便会突然变得极其负面和反感，当机器人和人类的相似度继续上升，相当于普通人之间的相似度的时候，人类对他们的情感反应会再度回到正面，产生人类与人类之间的移情作用。
- 也就是说，我们对于机器人的喜爱程度会随着机器人与人类的相似度而增加，但是当这种相似度达到一个点、介于机器人与真人之间时，我们的感情会由喜爱转变成厌恶与恐惧，对其的好感度跌落至谷底，这就是恐怖谷效应
- 恐怖谷效应主要是源于人们**对于与自己高度近似的新型事物的不安感与恐惧心理**



###  The Production Pipeline

[动画制作流程](https://zhida.zhihu.com/search?content_id=182201932&content_type=Article&match_order=1&q=动画制作流程&zhida_source=entity)：

![img](https://pica.zhimg.com/80/v2-099d2be9d83ed58541e31c6411d998d4_720w.webp)


compositiing：单独人物的动画制作，渲染也完成了，就可以拿出来放到场景中（就好像真人拍摄时，用绿布，[后期合成](https://zhida.zhihu.com/search?content_id=182201932&content_type=Article&match_order=1&q=后期合成&zhida_source=entity)的时候将绿幕去掉）



## 22 动画与模拟（求解常微分方程，刚体与流体）

### today

* 单粒子模拟
  * 显示欧拉方法
  * 不稳定性和提高
* 刚体模拟
* 流体模拟



[速度场](https://zhida.zhihu.com/search?content_id=182202289&content_type=Article&match_order=1&q=速度场&zhida_source=entity)：有位置有方向

![img](https://pic3.zhimg.com/80/v2-2e82655f4ef1fb0591322fe48f3c06f2_720w.webp)

- 为什么叫常微分方程呢？ 因为这里面不存在对别的变量的微分/导数
- 知道速度，计算速度场内粒子的任何时刻的位置需要计算[一阶常微分方程](https://zhida.zhihu.com/search?content_id=182202289&content_type=Article&match_order=1&q=一阶常微分方程&zhida_source=entity)

###  给出任意时间t，都能得出粒子的位置，怎么解呢？ 

####  欧拉方法 /前向欧拉/显式欧拉

- 欧拉方法最明显的特征：所有的数据都用上一时刻的去求下一时刻
- 知道上一个时刻t的速度，加速度，位移，给定时间△t，求出下一帧的速度，加速度和位移

![img](https://picx.zhimg.com/80/v2-66fd70f68a8e9b0646fdc4ffd2dc3779_720w.webp)

#####  问题：（始终用上一个时间的量去估计下一个时间的量，有误差） 

- △t越小，结果更精确

![img](https://picx.zhimg.com/80/v2-b8a70fc9641d60cd9bde9f6237ca3f85_720w.webp)

- 从稳定变成不稳定（不管步长取多小，一定不可能按照圆周运动的轨迹）

![img](https://picx.zhimg.com/80/v2-b9260b90ad614065a3ebd57777778ee1_720w.webp)

##### 总结： 

- 一切用[数值方法](https://zhida.zhihu.com/search?content_id=182202289&content_type=Article&match_order=1&q=数值方法&zhida_source=entity)去解微分方程都会面临的问题

- - **误差**（步长小，可以降低误差）

  - - 图形学上更关注你模拟出来的效果是不是更加的真实，物理上有误差不太重要

  - **不稳定**

- 

###  解决“不稳定” 

#### 1、中点法

![img](https://pic4.zhimg.com/80/v2-484eb924c4ccc6ece579379eafe3e8a7_720w.webp)

1. **用欧拉方法求出经过△t后的位置：a**
2. **求出原点和a点中点：b**
3. **从初始点开始，用b的速度和方向求出△t后的位置：c**


用了两次欧拉方法

![img](https://pic3.zhimg.com/80/v2-001c055a5ee9c1b1b6254506756713ae_720w.webp)

展开中点法的公式


中点法准确的原因：中点法比欧拉方法多了一个二次项，中点法模拟了一个抛物线的运动轨迹，算出了局部二次的模型

####  2、自适应改变步长 两次△t/2的应用 

1. 先用Δt来进行欧拉方法：a

2. 再用Δt/2[算两次](https://zhida.zhihu.com/search?content_id=182202289&content_type=Article&match_order=1&q=算两次&zhida_source=entity)：b

3. 如果最终两个点（a,b）位置相差较大，则应将步长减半重新计算；

4. 1. 如果结果相差较小，说明△t已经足够小了，没有必要再继续分下去

![img](https://pic3.zhimg.com/80/v2-d92ed6a518415e775c381254c29e4632_720w.webp)

####   3、隐式欧拉方法（后项欧拉） 


用的是下一帧的速度，加速度，来求现在的速度，加速度

![img](https://picx.zhimg.com/80/v2-8f5fc2b52b3c561190a933467fb7e245_720w.webp)

> 我的理解
>
> 显式欧拉方法的思路是使用上一时刻的导数（$F（t - 1, X_{t - 1}）$）去近似当前时刻的结果（$X_{t}$）。而隐式欧拉对其进行了改进：**使用当前时刻的导数（$F（t, X_{t}）$）近似当前时刻的结果（$X_t$）**。这是隐式欧拉和显式欧拉的唯一区别。用公式表示就是：
>
> 1. **向后差分**：隐式欧拉方法使用向后差分来近似导数（t+Δt的导数），即用来近似 h时间间隔内的导数。这种向后差分的形式是： f`(tn+1,yn+1)≈（yn+1−yn）/h 将这个近似值代入微分方程，得到隐式欧拉的更新方程。
>
> 
>
> ![NIGzq0.png](https://segmentfault.com/img/remote/1460000023058820)
>
> 绿线为 $\dot X_{1}$ 的真实值，黑线为隐式欧拉的得到的近似值，隐式欧拉同样也会产生误差。

但是不容易解

- 如何定义一个方法是否是稳定的？以及有多稳定？

- - 通过研究**[局部截断误差](https://zhida.zhihu.com/search?content_id=182202289&content_type=Article&match_order=1&q=局部截断误差&zhida_source=entity)（truncation error）和总体[累积误差](https://zhida.zhihu.com/search?content_id=182202289&content_type=Article&match_order=1&q=累积误差&zhida_source=entity)（total accumulated error）来衡量稳定性**
  - 人们认为研究这两个数是没有意义的，但是要研究他们的阶（与△t的关系）
  - 局部上将Δt变为1/2Δt时，在全局上Δt会变为1/4Δt，因此**阶数越高越好，减少阶数，误差可以成倍的减小**

![img](https://pic1.zhimg.com/80/v2-7b6f2c734fa83a58a3976ef0b0a662ac_720w.webp)

####   4、[龙格库塔](https://zhida.zhihu.com/search?content_id=182202289&content_type=Article&match_order=1&q=龙格库塔&zhida_source=entity)方法（一类方法）  

- 其中一个用的最多的方法：RK4（四阶）— 误差小

![img](https://pic2.zhimg.com/80/v2-873eb69a322da3fb48d0e9f042673735_720w.webp)

####   5、不是基于物理的方法 

- 比如基于位置法（Position Based）、韦尔莱积分等方法

- - 不保证能量守恒，只通过调整某些位置，使其能够满足模型中的一些特定性质。
  - 是一种不稳定的方法，但是简单且实现时间快。


**5.1 [流体模拟](https://zhida.zhihu.com/search?content_id=182202289&content_type=Article&match_order=1&q=流体模拟&zhida_source=entity)（Fluid Simulation）— Position Based**

- 认为水是由很多不可压缩的刚体小球组成的，在任何位置不可压缩，即**密度都一样**（假设）

![img](https://pic1.zhimg.com/80/v2-08ecccbaaaed215f090da0c263ae9e20_720w.webp)

***思路：\***

- 通过获取任意时刻小球的分布位置来获取小球单位面积的密度
- 如果有任何一个时刻小球分布的密度变成和平静水面时密度不一样，就要修正回来 — **通过改变小球的移动来修正小球密度不正确的地方**
- 修正的过程就是在模拟水花，水滴的运动

***更新：\***
**任何一个位置上把不正确的密度修正到正确的密度上，并且又知道如何调整小球的位置使得他的密度能回到我们想要的密度上去**（这里用了Gradient Descet（梯度下降法））
Gradient Descet（梯度下降法）— 机器学习的词汇：怎样通过调整输入，使得结果更和目标相似

**[物理模拟](https://zhida.zhihu.com/search?content_id=182202289&content_type=Article&match_order=1&q=物理模拟&zhida_source=entity)中模拟大规模的物质用到的两个不同思路：[质点法](https://zhida.zhihu.com/search?content_id=182202289&content_type=Article&match_order=1&q=质点法&zhida_source=entity)，网格法**

- **[拉格朗日法](https://zhida.zhihu.com/search?content_id=182202289&content_type=Article&match_order=1&q=拉格朗日法&zhida_source=entity)（俗称质点法）：比如鸟群的运动，模拟水。 —— 逐个模拟每个粒子**

- - 把鸟群里的每一只鸟的运动轨迹都正确模拟，得出鸟群的运动
  - 模拟水：将小水滴的运动挨个模拟得出总的结果

- **欧拉方法（俗称[网格法](https://zhida.zhihu.com/search?content_id=182202289&content_type=Article&match_order=2&q=网格法&zhida_source=entity)）：如何看待模拟一系列大规模的物体 —— 将一个空间定义为一个网格，通过观察以网格为单位的时间如何变换来模拟**

- - 整个空间分成不同网格，只考虑这个网格随着时间如何变化（不考虑这个时间内网格里是否进来了新的物体，或者离开了）
  - 跟上面的[常微分方程](https://zhida.zhihu.com/search?content_id=182202289&content_type=Article&match_order=3&q=常微分方程&zhida_source=entity)说的欧拉方法不是一回事

![img](https://pica.zhimg.com/80/v2-2a0ea674887a1777c194a5bae80c3040_720w.webp)



**Material Point Method (MPM，材质点方法) (结合了欧拉和拉格朗日)**

1. 认为不同粒子都具有某些材质属性，将这些属性存在于[粒子点](https://zhida.zhihu.com/search?content_id=182202289&content_type=Article&match_order=1&q=粒子点&zhida_source=entity)上
2. 将模拟变换的过程在网格里完成
3. 把网格里的信息写回网格内各个粒子里去

![img](https://pic2.zhimg.com/80/v2-79feeb9b7acae8f9740b1390780954cd_720w.webp)

###   [刚体模拟](https://zhida.zhihu.com/search?content_id=182202289&content_type=Article&match_order=1&q=刚体模拟&zhida_source=entity)（Rigid Body Simulation） 

- 刚体不会发生形变
- 模拟刚体可以相当于模拟粒子，只不过刚体这里考虑更多的物理量

![img](https://picx.zhimg.com/80/v2-105cf55403bd5362a743f59907ba8fad_720w.webp)

- - 位置对时间求导 → 速度
  - 旋转的角度对时间求导 → 角速度
  - 速度对时间求导 → 加速度
  - 角速度对时间求导 → 角



## 写在最后

参考资料：

[Games101个人学习笔记 - 知乎 (zhihu.com)](https://www.zhihu.com/column/c_1382761159972478976)

[Games101-笔记整理（中篇）13-16·光追 - 哔哩哔哩 (bilibili.com)](https://www.bilibili.com/read/cv23643854/#:~:text=13.1 引入光线追)

[games101笔记 - 知乎 (zhihu.com)](https://www.zhihu.com/column/c_1557069195413495808)

[Lec 14(2)-15(1) - 光的传播理论, Basic Radiometry 辐射度量学, 路径追踪与全局光照 (notion.site)](https://immmortal.notion.site/Lec-14-2-15-1-Basic-Radiometry-fd92b707a51e40f889e36885148c29c8#ec46a15f2008426f9afcaf5af97ee5cd)

[【GAMES101笔记速查——Lecture 09 Shading3(Texture Mapping Cont.） 】-CSDN博客](https://blog.csdn.net/weixin_45972089/article/details/142387200)

[GAMES101-现代计算机图形学入门-个人笔记（全） - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/434498517#:~:text=[GAMES101-)

[GAMES101 Lecture 10 Geometry 1 (Introduction) - Telluluu - 博客园 (cnblogs.com)](https://www.cnblogs.com/Tellulu/p/18092221)

鸣谢前人做出的努力，让后来者可以降低学习成本

（在已有基础上加上自己的理解自然比从0开始成本小得多）

笔记也更完善，前6个lecture基本没什么图片（



[WinMerge只显示差异部分的设置方法_winmerge怎么设置只显示差异-CSDN博客](https://blog.csdn.net/sxzlc/article/details/105881890)